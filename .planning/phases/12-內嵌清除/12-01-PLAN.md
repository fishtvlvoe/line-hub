---
phase: 12-內嵌清除
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/admin/class-users-column.php
  - includes/class-plugin.php
  - assets/css/users-column.css
  - assets/js/welcome-toast.js
autonomous: true
requirements:
  - INLINE-01
  - INLINE-02

must_haves:
  truths:
    - "WordPress 用戶列表頁面的 LINE 欄位樣式正常顯示（寬度 60px、綠色勾勾、灰色來源標籤）"
    - "LIFF 登入後的歡迎 Toast 通知正常顯示（綠色橫幅、3 秒後自動消失、Cookie 清除）"
    - "class-users-column.php 和 class-plugin.php 中無任何 <style> 或 <script> 標籤"
  artifacts:
    - path: "assets/css/users-column.css"
      provides: "用戶列表 LINE 欄位樣式"
      contains: ".column-line_binding"
    - path: "assets/js/welcome-toast.js"
      provides: "LIFF 登入歡迎 Toast 邏輯"
      contains: "lineHubToast"
  key_links:
    - from: "includes/admin/class-users-column.php"
      to: "assets/css/users-column.css"
      via: "wp_enqueue_style in admin_head-users.php hook"
      pattern: "wp_enqueue_style.*users-column"
    - from: "includes/class-plugin.php"
      to: "assets/js/welcome-toast.js"
      via: "wp_enqueue_script in wp_head hook"
      pattern: "wp_enqueue_script.*welcome-toast"
---

<objective>
將 class-users-column.php 的內嵌 CSS 和 class-plugin.php 的內嵌 Toast JS 提取到獨立檔案，透過 WordPress 標準 enqueue 機制載入。

Purpose: 消除兩個 Class 檔案中的 `<style>` 和 `<script>` 標籤，符合熵減原則「PHP 只做加載」
Output: 2 個新的 asset 檔案 + 2 個修改後的 Class 檔案
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/admin/class-users-column.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 提取 UsersColumn 內嵌 CSS 到獨立檔案</name>
  <files>
    includes/admin/class-users-column.php
    assets/css/users-column.css
  </files>
  <action>
1. 建立 `assets/css/users-column.css`，內容從 `class-users-column.php` 第 144-149 行的 `<style>` 區塊提取：
   ```css
   .column-line_binding { width: 60px; text-align: center; }
   .line-hub-binding-linked { color: #06C755; font-size: 16px; }
   .line-hub-binding-none { color: #ccc; }
   .line-hub-binding-source { display: block; color: #888; font-size: 11px; }
   ```

2. 修改 `class-users-column.php`：
   - 將 `inline_css()` 方法改為使用 `wp_enqueue_style`：
     ```php
     public static function inline_css(): void {
         wp_enqueue_style(
             'line-hub-users-column',
             LINE_HUB_URL . 'assets/css/users-column.css',
             [],
             LINE_HUB_VERSION
         );
     }
     ```
   - 方法名稱保持 `inline_css` 不變（init() 中的 hook 引用不需改動），但方法體改為 enqueue

3. 驗證：方法中無 `echo '<style'` 殘留
  </action>
  <verify>
    <automated>cd /Users/fishtv/Development/line-hub && php -l includes/admin/class-users-column.php && grep -c '<style' includes/admin/class-users-column.php | grep -q '^0$' && echo "PASS: no inline style" || echo "FAIL: inline style found"</automated>
    <manual>在 WordPress 後台 /wp-admin/users.php 確認 LINE 欄位樣式正常</manual>
  </verify>
  <done>class-users-column.php 中零 `<style>` 標籤，CSS 透過 wp_enqueue_style 載入，用戶列表外觀不變</done>
</task>

<task type="auto">
  <name>Task 2: 提取 Plugin 歡迎 Toast 內嵌 JS 到獨立檔案</name>
  <files>
    includes/class-plugin.php
    assets/js/welcome-toast.js
  </files>
  <action>
1. 建立 `assets/js/welcome-toast.js`，提取 `class-plugin.php` 第 370-383 行的 Toast 邏輯。因為原始碼使用 PHP 變數 `$display_name`，改為透過 `wp_localize_script` 傳遞：
   ```js
   (function(){
       document.addEventListener('DOMContentLoaded', function(){
           var config = window.lineHubWelcomeToast || {};
           var displayName = config.displayName || '';
           if (!displayName) return;

           var d = document.createElement('div');
           d.id = 'lineHubToast';
           d.innerHTML = config.message.replace('{name}', '<strong>' + displayName + '</strong>');
           d.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:999999;background:#06C755;color:#fff;text-align:center;padding:12px 16px;font-size:15px;font-weight:500;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;transform:translateY(-100%);transition:transform .3s ease;';
           document.body.insertBefore(d, document.body.firstChild);
           setTimeout(function(){ d.style.transform = 'translateY(0)'; }, 300);
           setTimeout(function(){ d.style.transform = 'translateY(-100%)'; }, 4000);
           setTimeout(function(){ d.remove(); }, 4500);
           // 清除 cookie
           document.cookie = 'line_hub_welcome=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
       });
   })();
   ```

2. 修改 `class-plugin.php` 的 `enqueue_frontend_assets()` 方法（第 363-386 行）：
   - 保留 cookie 和登入狀態檢查（第 365-366 行）
   - 將 `add_action('wp_head', ...)` 的匿名函數改為 `wp_enqueue_script` + `wp_localize_script`：
     ```php
     if (isset($_COOKIE['line_hub_welcome']) && is_user_logged_in()) {
         $user = wp_get_current_user();
         wp_enqueue_script(
             'line-hub-welcome-toast',
             LINE_HUB_URL . 'assets/js/welcome-toast.js',
             [],
             LINE_HUB_VERSION,
             true
         );
         wp_localize_script('line-hub-welcome-toast', 'lineHubWelcomeToast', [
             'displayName' => $user->display_name,
             'message'     => __('已以 {name} 登入', 'line-hub'),
         ]);
     }
     ```
   - 完全移除原本的 `add_action('wp_head', function() ...)` 和其中的 `<script>` 區塊

3. 注意：inline style（`d.style.cssText`）保留在 JS 中是合理的——這是 Toast 動畫的一次性 DOM 操作，不適合拆到 CSS 檔案（元素是動態建立的，且 Phase 13 才處理 inline style）
  </action>
  <verify>
    <automated>cd /Users/fishtv/Development/line-hub && php -l includes/class-plugin.php && grep -c '<script' includes/class-plugin.php | grep -q '^0$' && echo "PASS: no inline script" || echo "FAIL: inline script found"</automated>
    <manual>設定 line_hub_welcome cookie 後重新載入頁面，確認歡迎 Toast 正常顯示</manual>
  </verify>
  <done>class-plugin.php 中零 `<script>` 標籤，Toast JS 透過 wp_enqueue_script 載入，歡迎通知行為不變</done>
</task>

</tasks>

<verification>
整體驗證（兩個 Task 完成後）：

```bash
# 確認 class-users-column.php 無 <style>
grep -rn '<style' includes/admin/class-users-column.php
# 預期：零結果

# 確認 class-plugin.php 無 <script>
grep -rn '<script' includes/class-plugin.php
# 預期：零結果

# 確認新 asset 檔案存在
ls -la assets/css/users-column.css assets/js/welcome-toast.js
# 預期：兩個檔案都存在

# PHP 語法檢查
php -l includes/admin/class-users-column.php
php -l includes/class-plugin.php
# 預期：No syntax errors
```
</verification>

<success_criteria>
1. `grep -rn '<style' includes/admin/class-users-column.php` 結果為零
2. `grep -rn '<script' includes/class-plugin.php` 結果為零
3. `assets/css/users-column.css` 和 `assets/js/welcome-toast.js` 存在且內容正確
4. PHP 語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/12-內嵌清除/12-01-SUMMARY.md`
</output>
