---
phase: 12-內嵌清除
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/integration/class-fluent-cart-connector.php
  - assets/css/fluentcart-binding.css
  - assets/js/fluentcart-binding.js
  - assets/js/fluentcart-login-banner.js
  - includes/templates/fluentcart-binding.php
autonomous: true
requirements:
  - INLINE-01
  - INLINE-02
  - INLINE-03

must_haves:
  truths:
    - "FluentCart 客戶入口頁面的 LINE 綁定區塊正常顯示（卡片、頭像、綁定/解綁按鈕）"
    - "解除綁定按鈕點擊後呼叫 REST API 並顯示成功/失敗訊息"
    - "未登入用戶在 FluentCart 產品頁看到 LINE 登入提示橫幅"
    - "class-fluent-cart-connector.php 中無任何 <style>、<script> 或大段 HTML echo"
  artifacts:
    - path: "assets/css/fluentcart-binding.css"
      provides: "FluentCart 綁定區塊樣式"
      contains: ".lh-fc-binding"
    - path: "assets/js/fluentcart-binding.js"
      provides: "FluentCart 解綁互動邏輯"
      contains: "lhFcUnbindBtn"
    - path: "assets/js/fluentcart-login-banner.js"
      provides: "FluentCart 產品頁登入提示注入"
      contains: "line-hub-login-banner"
    - path: "includes/templates/fluentcart-binding.php"
      provides: "FluentCart 綁定區塊 HTML 模板"
      contains: "lh-fc-binding"
  key_links:
    - from: "includes/integration/class-fluent-cart-connector.php"
      to: "assets/css/fluentcart-binding.css"
      via: "wp_enqueue_style in renderBindingSection"
      pattern: "wp_enqueue_style.*fluentcart-binding"
    - from: "includes/integration/class-fluent-cart-connector.php"
      to: "assets/js/fluentcart-binding.js"
      via: "wp_enqueue_script in renderBindingSection"
      pattern: "wp_enqueue_script.*fluentcart-binding"
    - from: "includes/integration/class-fluent-cart-connector.php"
      to: "includes/templates/fluentcart-binding.php"
      via: "include in renderBindingSection"
      pattern: "include.*fluentcart-binding\\.php"
    - from: "includes/integration/class-fluent-cart-connector.php"
      to: "assets/js/fluentcart-login-banner.js"
      via: "wp_enqueue_script in injectLoginBanner"
      pattern: "wp_enqueue_script.*fluentcart-login-banner"
---

<objective>
將 class-fluent-cart-connector.php 中的全部內嵌 CSS（120 行）、JS（40 行）和大段 HTML 模板提取到獨立檔案，實現 Class 零內嵌。

Purpose: 這是 Phase 12 最複雜的提取工作。FluentCartConnector 包含完整的 LINE 綁定 UI（CSS + HTML + JS 互動），全部拆分後 Class 只負責加載邏輯。
Output: 3 個新 asset 檔案 + 1 個新模板檔案 + 1 個大幅瘦身的 Class 檔案
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/integration/class-fluent-cart-connector.php
@includes/templates/profile-binding.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 提取 renderBindingSection 的 CSS 和 JS 到獨立檔案</name>
  <files>
    assets/css/fluentcart-binding.css
    assets/js/fluentcart-binding.js
    assets/js/fluentcart-login-banner.js
  </files>
  <action>
1. 建立 `assets/css/fluentcart-binding.css`——提取 `class-fluent-cart-connector.php` 第 178-301 行的 `<style>` 區塊（約 120 行 CSS），包含：
   - `.lh-fc-binding` 容器樣式
   - `.lh-fc-binding-title` 標題
   - `.lh-fc-binding-card` 卡片
   - `.lh-fc-avatar` / `.lh-fc-avatar-empty` 頭像
   - `.lh-fc-details` / `.lh-fc-name` / `.lh-fc-uid` / `.lh-fc-date` 詳情
   - `.lh-fc-actions` / `.lh-fc-btn` / `.lh-fc-btn-bind` / `.lh-fc-btn-unbind` 按鈕
   - `.lh-fc-unbound` 未綁定狀態
   - `.lh-fc-status` 狀態訊息
   保持 CSS 內容完全一致，不做任何修改。

2. 建立 `assets/js/fluentcart-binding.js`——提取第 359-400 行的解綁 JS 邏輯。原始碼使用 PHP `esc_js()` 注入 i18n 字串，改為從 `wp_localize_script` 讀取：
   ```js
   (function(){
       var btn = document.getElementById('lhFcUnbindBtn');
       if (!btn) return;

       var i18n = window.lineHubFcBinding || {};

       btn.addEventListener('click', function(){
           if (!confirm(i18n.confirmUnbind || 'Confirm?')) return;

           var el = this;
           var status = document.getElementById('lhFcStatus');
           el.disabled = true;
           el.textContent = i18n.processing || '...';

           fetch(el.dataset.restUrl, {
               method: 'DELETE',
               headers: { 'X-WP-Nonce': el.dataset.nonce, 'Content-Type': 'application/json' },
               credentials: 'same-origin'
           })
           .then(function(r){ return r.json(); })
           .then(function(data){
               if (data.success) {
                   status.className = 'lh-fc-status';
                   status.style.cssText = 'display:block;background:#dcfce7;color:#166534;';
                   status.textContent = data.message || i18n.unbindSuccess || '';
                   setTimeout(function(){ location.reload(); }, 1500);
               } else {
                   status.className = 'lh-fc-status';
                   status.style.cssText = 'display:block;background:#fef2f2;color:#991b1b;';
                   status.textContent = data.message || i18n.unbindFail || '';
                   el.disabled = false;
                   el.textContent = i18n.unbindLabel || '';
               }
           })
           .catch(function(){
               status.style.cssText = 'display:block;background:#fef2f2;color:#991b1b;';
               status.textContent = i18n.networkError || '';
               el.disabled = false;
               el.textContent = i18n.unbindLabel || '';
           });
       });
   })();
   ```

3. 建立 `assets/js/fluentcart-login-banner.js`——提取 `injectLoginBanner` 方法第 91-117 行的產品頁登入提示注入 JS。原始碼使用 PHP 變數注入 banner 內容，改為從 `wp_localize_script` 讀取：
   ```js
   (function(){
       document.addEventListener('DOMContentLoaded', function(){
           var config = window.lineHubLoginBanner || {};
           if (!config.bannerText || !config.loginUrl) return;

           var targets = [
               '.fcs_product_single',
               '.fluent-product-page',
               '.fc-product-single',
               '[data-fluent-cart-product]',
               '.entry-content'
           ];
           var container = null;
           for (var i = 0; i < targets.length; i++) {
               container = document.querySelector(targets[i]);
               if (container) break;
           }
           if (!container) return;

           var banner = document.createElement('div');
           banner.className = 'line-hub-login-banner';
           banner.innerHTML = '<span class="line-hub-login-banner-text">' + config.bannerText + '</span>' +
               '<a href="' + config.loginUrl + '" class="line-hub-login-btn">' +
               '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 2C6.48 2 2 5.81 2 10.5c0 2.49 1.31 4.71 3.37 6.26.14.1.23.28.23.47l-.05 1.76c-.02.63.55 1.11 1.14.96l1.96-.52c.15-.04.31-.03.46.02.98.35 2.04.55 3.14.55h.5c-.03-.25-.05-.51-.05-.77 0-3.83 3.55-6.95 7.93-6.95.34 0 .68.02 1.01.06C21.17 5.36 17.02 2 12 2z"/></svg>' +
               config.buttonText + '</a>';

           container.insertBefore(banner, container.firstChild);
       });
   })();
   ```

4. 注意 XSS 安全：`wp_localize_script` 自動處理 JSON 編碼，URL 在 PHP 端已經過 `esc_url()`，文字已經過 `esc_html()`，因此 JS 中直接使用是安全的。
  </action>
  <verify>
    <automated>cd /Users/fishtv/Development/line-hub && test -f assets/css/fluentcart-binding.css && test -f assets/js/fluentcart-binding.js && test -f assets/js/fluentcart-login-banner.js && echo "PASS: all 3 asset files exist" || echo "FAIL: missing asset files"</automated>
  </verify>
  <done>3 個新 asset 檔案建立完成，包含從 class-fluent-cart-connector.php 提取的 CSS 和 JS 邏輯</done>
</task>

<task type="auto">
  <name>Task 2: 提取 renderBindingSection HTML 到模板 + 重寫 Class 方法為純加載</name>
  <files>
    includes/integration/class-fluent-cart-connector.php
    includes/templates/fluentcart-binding.php
  </files>
  <action>
1. 建立 `includes/templates/fluentcart-binding.php`——提取 `renderBindingSection` 第 303-357 行的 HTML 模板。模板接收以下變數（由 Class 方法傳入）：
   - `$is_bound` (bool)
   - `$display_name` (string)
   - `$picture_url` (string)
   - `$binding` (object|null) — 需要 `$binding->line_uid` 和 `$binding->created_at`
   - `$linked_at` (string)
   - `$nonce` (string)
   - `$rest_url` (string)
   - `$bind_url` (string)

   模板結構（保持原始 HTML 完全一致）：
   ```php
   <?php
   /**
    * FluentCart 客戶入口 LINE 綁定區塊模板
    *
    * 可用變數：
    * @var bool   $is_bound    是否已綁定
    * @var string $display_name LINE 顯示名稱
    * @var string $picture_url LINE 頭像 URL
    * @var object $binding     綁定資料物件
    * @var string $linked_at   綁定時間
    * @var string $nonce       REST API nonce
    * @var string $rest_url    REST API URL
    * @var string $bind_url    LIFF 綁定 URL
    *
    * @package LineHub
    */
   if (!defined('ABSPATH')) { exit; }
   ?>
   <div class="lh-fc-binding" id="lineHubFcBinding">
       <!-- 保持原始 HTML 結構完全一致 -->
   </div>
   ```

2. 重寫 `class-fluent-cart-connector.php` 的 `renderBindingSection()` 方法：
   - 保留第 143-176 行的變數準備邏輯（binding 查詢、URL 建立等）
   - 移除第 177-301 行的 `<style>` 區塊，改為 `wp_enqueue_style`
   - 移除第 303-357 行的 HTML 區塊，改為 `include LINE_HUB_PATH . 'includes/templates/fluentcart-binding.php'`
   - 移除第 359-400 行的 `<script>` 區塊，改為 `wp_enqueue_script` + `wp_localize_script`

   重寫後的 renderBindingSection 結構：
   ```php
   public static function renderBindingSection(): void {
       // （保留原始的登入檢查和變數準備邏輯）

       // 載入 CSS
       wp_enqueue_style(
           'line-hub-fluentcart-binding',
           LINE_HUB_URL . 'assets/css/fluentcart-binding.css',
           [],
           LINE_HUB_VERSION
       );

       // 載入 JS + i18n
       wp_enqueue_script(
           'line-hub-fluentcart-binding',
           LINE_HUB_URL . 'assets/js/fluentcart-binding.js',
           [],
           LINE_HUB_VERSION,
           true
       );
       wp_localize_script('line-hub-fluentcart-binding', 'lineHubFcBinding', [
           'confirmUnbind' => __('確定要解除 LINE 綁定嗎？', 'line-hub'),
           'processing'    => __('處理中...', 'line-hub'),
           'unbindSuccess' => __('LINE 綁定已解除', 'line-hub'),
           'unbindFail'    => __('解除綁定失敗', 'line-hub'),
           'unbindLabel'   => __('解除綁定', 'line-hub'),
           'networkError'  => __('網路錯誤，請稍後再試', 'line-hub'),
       ]);

       // 載入 HTML 模板
       include LINE_HUB_PATH . 'includes/templates/fluentcart-binding.php';
   }
   ```

3. 重寫 `injectLoginBanner()` 方法：
   - 保留 CSS enqueue（第 68-73 行，已正確使用 wp_enqueue_style）
   - 保留 login URL 計算和空值檢查
   - 移除第 91-118 行的 `<script>` 區塊，改為 `wp_enqueue_script` + `wp_localize_script`：
   ```php
   wp_enqueue_script(
       'line-hub-fluentcart-login-banner',
       LINE_HUB_URL . 'assets/js/fluentcart-login-banner.js',
       [],
       LINE_HUB_VERSION,
       true
   );
   wp_localize_script('line-hub-fluentcart-login-banner', 'lineHubLoginBanner', [
       'bannerText' => esc_html__('登入後可追蹤訂單、接收出貨通知', 'line-hub'),
       'buttonText' => esc_html__('LINE 登入', 'line-hub'),
       'loginUrl'   => esc_url($login_url),
   ]);
   ```

4. 重要注意事項：
   - `injectLoginBanner` 原本掛在 `wp_head` action（優先級 20），改用 enqueue 後不再需要 `wp_head` action，直接在方法中 enqueue 即可（WordPress 會在正確位置輸出）。但因為此方法本身是透過 `wp_head` action 呼叫的（見 maybeShowLoginPrompt 第 60 行的 `add_action('wp_head', ...)`），enqueue 在 `wp_head` 中仍然有效。
   - 模板中已有的 `esc_html()`、`esc_url()`、`esc_attr()` 轉義函數保持不變。
  </action>
  <verify>
    <automated>cd /Users/fishtv/Development/line-hub && php -l includes/integration/class-fluent-cart-connector.php && php -l includes/templates/fluentcart-binding.php && grep -c '<style\|<script' includes/integration/class-fluent-cart-connector.php | grep -q '^0$' && echo "PASS: no inline code" || echo "FAIL: inline code found"</automated>
    <manual>在 FluentCart 客戶入口頁面確認 LINE 綁定區塊正常顯示，解綁按鈕可正常互動</manual>
  </verify>
  <done>class-fluent-cart-connector.php 中零 `<style>`、零 `<script>`、零大段 HTML。所有前端資源透過 wp_enqueue 和模板 include 載入。FluentCart 綁定功能不變。</done>
</task>

</tasks>

<verification>
整體驗證（Phase 12 全部完成後）：

```bash
# 確認所有 Class 檔案無 <style>
grep -rn '<style' includes/ --include='class-*.php'
# 預期：零結果（LIFF 模板不在此範圍）

# 確認所有 Class 檔案無 <script>
grep -rn '<script' includes/ --include='class-*.php'
# 預期：零結果

# PHP 語法檢查
php -l includes/integration/class-fluent-cart-connector.php
php -l includes/templates/fluentcart-binding.php
# 預期：No syntax errors

# 確認新檔案都存在
ls -la assets/css/fluentcart-binding.css assets/js/fluentcart-binding.js assets/js/fluentcart-login-banner.js includes/templates/fluentcart-binding.php
# 預期：4 個檔案都存在
```
</verification>

<success_criteria>
1. `grep -rn '<style' includes/ --include='class-*.php'` 結果為零
2. `grep -rn '<script' includes/ --include='class-*.php'` 結果為零
3. 4 個新檔案存在且內容正確
4. PHP 語法檢查全部通過
5. FluentCart 產品頁登入提示和客戶入口綁定區塊外觀與功能不變
</success_criteria>

<output>
After completion, create `.planning/phases/12-內嵌清除/12-02-SUMMARY.md`
</output>
