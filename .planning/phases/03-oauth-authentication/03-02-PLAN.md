---
phase: 03-oauth-authentication
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - includes/auth/class-auth-callback.php
  - includes/class-plugin.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "用戶訪問 /line-hub/auth/ 會被重定向到 LINE 授權頁面"
    - "LINE 回調時系統驗證 State 參數防止 CSRF"
    - "State 過期時顯示友善錯誤訊息「登入逾時，請重新登入」"
    - "LINE 回傳錯誤時顯示用戶可理解的訊息"
    - "成功認證後觸發用戶處理流程"
  artifacts:
    - path: "includes/auth/class-auth-callback.php"
      provides: "OAuth 認證流程處理器"
      min_lines: 100
    - path: "includes/class-plugin.php"
      provides: "路由註冊（rewrite rules）"
      contains: "line-hub/auth"
  key_links:
    - from: "includes/auth/class-auth-callback.php"
      to: "includes/auth/class-oauth-client.php"
      via: "new OAuthClient()"
      pattern: "new OAuthClient"
    - from: "includes/auth/class-auth-callback.php"
      to: "includes/auth/class-oauth-state.php"
      via: "OAuthState::validate"
      pattern: "OAuthState::validate"
    - from: "includes/class-plugin.php"
      to: "includes/auth/class-auth-callback.php"
      via: "template_redirect hook"
      pattern: "template_redirect.*AuthCallback"
---

<objective>
建立 OAuth 認證流程處理器和路由

Purpose: 處理完整的 OAuth 認證流程，包括發起認證、接收回調、驗證 State、處理錯誤
Output: AuthCallback 類別和 WordPress rewrite rules 整合
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-oauth-authentication/03-RESEARCH.md
@.planning/phases/03-oauth-authentication/03-01-SUMMARY.md

# 依賴的 Auth 類別
@includes/auth/class-oauth-state.php
@includes/auth/class-oauth-client.php
@includes/class-plugin.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 AuthCallback 類別</name>
  <files>includes/auth/class-auth-callback.php</files>
  <action>
建立 `LineHub\Auth\AuthCallback` 類別，處理 OAuth 認證流程：

**公開方法：**

1. `handleRequest(): void`
   - 主要入口點，處理 `/line-hub/auth/` 和 `/line-hub/auth/callback` 請求
   - 使用 try-catch 包裝所有處理邏輯
   - 錯誤時呼叫 handleError()

   邏輯流程：
   ```
   if (有 error 參數)
       → handleError(error_description)

   if (有 code 和 state 參數)
       → processCallback(code, state)

   else (直接訪問 /line-hub/auth/)
       → initiateAuth()
   ```

2. `initiateAuth(): void`
   - 儲存原始頁面 URL（如果有 redirect 參數）
   - 建立 OAuthClient 實例
   - 取得授權 URL（含 State）
   - 重定向到 LINE 授權頁面
   - 使用 `header('Location: ' . $auth_url); exit;`

3. `processCallback(string $code, string $state): void`
   - 驗證 State（CSRF 防護）
   - State 無效時拋出 Exception：「登入逾時，請重新登入」

   成功驗證後：
   - 建立 OAuthClient 實例
   - 交換 code 取得 tokens
   - 驗證 ID Token 取得用戶資料
   - 取得 LINE Profile
   - 合併資料準備給 LoginService：
     ```php
     $user_data = [
         'userId'      => $profile['userId'],
         'displayName' => $profile['displayName'] ?? '',
         'pictureUrl'  => $profile['pictureUrl'] ?? '',
         'email'       => $id_token_data['email'] ?? '',
     ];
     ```
   - 呼叫 LoginService::handleUser($user_data, $tokens)

   注意：LoginService 在 Plan 03-03 實作，此處先用 placeholder 邏輯

**私有方法：**

4. `handleError(string $message): void`
   - 記錄錯誤到 debug.log
   - 顯示友善錯誤頁面（不是技術錯誤訊息）
   - 提供「重新登入」連結
   - 使用 wp_die() 或自訂模板

**錯誤訊息對應（用戶友善）：**
- access_denied → 「您已取消登入」
- invalid_request → 「登入請求無效，請重試」
- server_error → 「LINE 伺服器暫時無法連線，請稍後再試」
- 其他 → 「登入時發生錯誤，請重試」
- State 過期 → 「登入逾時，請重新登入」（用戶決策）

**注意：**
- LoginService::handleUser() 目前不存在，先用 placeholder 或 TODO 註解
- 此 Task 只負責 OAuth 流程，用戶處理在 Plan 03-03
  </action>
  <verify>
檢查核心方法和錯誤處理：
```bash
grep -E "(function handleRequest|function initiateAuth|function processCallback|function handleError|登入逾時)" includes/auth/class-auth-callback.php
```
  </verify>
  <done>
AuthCallback 類別完成，可處理認證發起、回調驗證、錯誤顯示
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 Plugin 類別註冊 Auth 路由</name>
  <files>includes/class-plugin.php</files>
  <action>
修改 `LineHub\Plugin` 類別，加入 OAuth 路由：

**1. 在 register_hooks() 加入路由相關 hooks：**
```php
// OAuth 認證路由
add_action('init', [$this, 'register_auth_routes'], 15);
add_action('template_redirect', [$this, 'handle_auth_requests'], 10);
```

**2. 新增 register_auth_routes() 方法：**
```php
public function register_auth_routes(): void {
    // 添加 rewrite rules
    add_rewrite_rule(
        '^line-hub/auth/?$',
        'index.php?line_hub_auth=1',
        'top'
    );
    add_rewrite_rule(
        '^line-hub/auth/callback/?$',
        'index.php?line_hub_auth=callback',
        'top'
    );

    // 註冊 query vars
    add_filter('query_vars', function($vars) {
        $vars[] = 'line_hub_auth';
        return $vars;
    });
}
```

**3. 新增 handle_auth_requests() 方法：**
```php
public function handle_auth_requests(): void {
    $auth_action = get_query_var('line_hub_auth');

    if (empty($auth_action)) {
        return;
    }

    // 處理認證請求
    $callback = new Auth\AuthCallback();
    $callback->handleRequest();
    exit;
}
```

**4. 在外掛啟用時 flush rewrite rules：**
在 `line-hub.php` 的啟用 hook 中加入：
```php
register_activation_hook(__FILE__, function() {
    // ... 現有的資料表建立 ...

    // Flush rewrite rules
    flush_rewrite_rules();
});
```

**路由說明：**
- `/line-hub/auth/` - 發起 OAuth 認證
- `/line-hub/auth/callback` - LINE 回調端點
- 可選參數：`?redirect=原始頁面URL`
  </action>
  <verify>
檢查路由註冊和處理：
```bash
grep -E "(line-hub/auth|line_hub_auth|register_auth_routes|handle_auth_requests|AuthCallback)" includes/class-plugin.php
```
  </verify>
  <done>
OAuth 路由在 Plugin 類別註冊完成，/line-hub/auth/ 和 /line-hub/auth/callback 可正常訪問
  </done>
</task>

</tasks>

<verification>
## 路由測試

1. **路由可訪問性：**
   - 訪問 `/line-hub/auth/` 應該重定向到 LINE 授權頁面
   - 訪問 `/line-hub/auth/?redirect=https://example.com/page` 應該儲存 redirect

2. **回調處理：**
   - `/line-hub/auth/callback?code=xxx&state=yyy` 應該進入 processCallback
   - State 不匹配時顯示「登入逾時」

3. **錯誤處理：**
   - `/line-hub/auth/callback?error=access_denied` 顯示「您已取消登入」

## 程式碼品質

1. 確認 namespace 正確（LineHub\Auth）
2. 確認使用 sanitize_text_field 處理 GET 參數
3. 確認使用 esc_url 處理 redirect URL
</verification>

<success_criteria>
1. /line-hub/auth/ 路由可正常訪問並重定向到 LINE
2. State 參數正確產生並儲存
3. 回調時 State 驗證正確執行
4. 錯誤訊息友善易懂（非技術用語）
5. redirect 參數正確儲存用於登入後重定向
</success_criteria>

<output>
完成後建立 `.planning/phases/03-oauth-authentication/03-02-SUMMARY.md`
</output>
