---
phase: 03-oauth-authentication
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - includes/services/class-login-service.php
  - includes/auth/email-form-template.php
  - includes/auth/class-auth-callback.php
autonomous: true
user_setup: []

must_haves:
  truths:
    - "新用戶登入時自動建立 WordPress 帳號（subscriber 角色）"
    - "新用戶的 username 唯一且符合 WordPress 規範"
    - "Email 已存在時自動綁定到現有帳號（用戶決策）"
    - "Email 缺失時用戶可以補充 Email 或選擇重新授權"
    - "登入完成後同步 LINE 頭像到 WordPress"
    - "登入完成後重定向到原始頁面或首頁"
  artifacts:
    - path: "includes/services/class-login-service.php"
      provides: "用戶登入/註冊協調服務"
      min_lines: 150
    - path: "includes/auth/email-form-template.php"
      provides: "Email 輸入表單模板"
      min_lines: 40
  key_links:
    - from: "includes/services/class-login-service.php"
      to: "includes/services/class-user-service.php"
      via: "UserService::linkUser"
      pattern: "UserService::linkUser"
    - from: "includes/services/class-login-service.php"
      to: "WordPress wp_insert_user"
      via: "wp_insert_user"
      pattern: "wp_insert_user"
    - from: "includes/services/class-login-service.php"
      to: "WordPress wp_set_auth_cookie"
      via: "wp_set_auth_cookie"
      pattern: "wp_set_auth_cookie"
    - from: "includes/auth/class-auth-callback.php"
      to: "includes/services/class-login-service.php"
      via: "LoginService::handleUser"
      pattern: "LoginService.*handleUser"
---

<objective>
建立用戶登入/註冊服務和 Email 表單處理

Purpose: 完成 OAuth 認證的最後一環：用戶帳號建立、登入、資料同步、Email 補救
Output: LoginService 類別和 Email 輸入表單模板
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-oauth-authentication/03-RESEARCH.md
@.planning/phases/03-oauth-authentication/03-01-SUMMARY.md
@.planning/phases/03-oauth-authentication/03-02-SUMMARY.md

# 依賴的服務和 Auth 類別
@includes/services/class-user-service.php
@includes/auth/class-oauth-state.php
@includes/auth/class-oauth-client.php
@includes/auth/class-auth-callback.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 LoginService 類別</name>
  <files>includes/services/class-login-service.php</files>
  <action>
建立 `LineHub\Services\LoginService` 類別，處理用戶登入/註冊：

**常數定義：**
```php
private const USER_PREFIX = 'line_';  // Username 前綴
private const USER_FALLBACK = 'user_'; // Display name 無效時的 fallback
```

**公開方法：**

1. `handleUser(array $user_data, array $tokens): void`
   - 主要入口點，從 AuthCallback 呼叫
   - $user_data 包含：userId, displayName, pictureUrl, email

   邏輯流程：
   ```
   Step 1: 檢查 LINE UID 是否已綁定到 WordPress 用戶
           → 如果是，直接登入該用戶

   Step 2: 檢查 Email 是否存在
           → 如果 Email 為空，顯示 Email 輸入表單

   Step 3: 檢查 Email 是否已被其他 WordPress 帳號使用
           → 如果是，綁定 LINE 到該帳號並登入（用戶決策：同 Email = 同人）

   Step 4: 建立新 WordPress 帳號
           → 綁定 LINE 並登入
   ```

2. `handleEmailSubmit(): void`
   - 處理 Email 表單提交（POST 請求）
   - 驗證 nonce
   - 從 Transient 取得暫存的用戶資料
   - 驗證 Email 格式
   - 呼叫 handleUser() 繼續流程

3. `static generateUsername(string $display_name): string`
   - 參考 NSL 的 username 生成邏輯：
     1. 轉小寫、移除空格
     2. 使用 sanitize_user($name, true) 清理
     3. 加上 USER_PREFIX 前綴
     4. 如果結果為空（例如純中文），使用 fallback + random hash
     5. 檢查 username_exists()，如有衝突加數字後綴
     6. 確保長度不超過 60 字元
   - 返回唯一的 username

**私有方法：**

4. `createUser(array $user_data): int`
   - 使用 wp_insert_user() 建立用戶
   - 參數：
     - user_login: generateUsername($displayName)
     - user_email: $email
     - user_pass: wp_generate_password(12, false)
     - display_name: $displayName
     - role: 'subscriber'（用戶決策）
   - 設置 default_password_nag 提示用戶設定密碼
   - 觸發 line_hub/user/registered action
   - 返回 user_id

5. `loginUser(int $user_id, array $user_data, array $tokens): void`
   - 呼叫 UserService::updateProfile() 同步資料
   - 可選：儲存 access_token（根據設定）
   - 設置 WordPress 登入：
     - wp_set_current_user($user_id)
     - wp_set_auth_cookie($user_id, true, is_ssl())
   - 觸發 hooks：
     - line_hub/user/logged_in
     - wp_login
   - 重定向到原始頁面（OAuthState::getRedirect()）或首頁

6. `showEmailForm(array $user_data, array $tokens): void`
   - 產生唯一的暫存 key
   - 將用戶資料和 tokens 儲存到 Transient（10 分鐘）
   - 載入 email-form-template.php
   - exit 結束請求

**頭像同步（AUTH-06）：**
在 loginUser() 或 createUser() 後：
- 將 LINE pictureUrl 儲存為 user_meta：`line_hub_avatar_url`
- 可選：整合 WP User Avatar 或 Simple Local Avatars 外掛

**安全要點：**
- Email 表單使用 wp_nonce_field
- 驗證使用 wp_verify_nonce
- 使用 sanitize_email 處理輸入
- 使用 wp_safe_redirect 重定向
  </action>
  <verify>
檢查核心方法和用戶流程：
```bash
grep -E "(function handleUser|function createUser|function loginUser|function generateUsername|wp_insert_user|wp_set_auth_cookie)" includes/services/class-login-service.php
```
  </verify>
  <done>
LoginService 類別完成，包含用戶登入、註冊、Username 生成、Email 處理功能
  </done>
</task>

<task type="auto">
  <name>Task 2: 建立 Email 輸入表單模板</name>
  <files>includes/auth/email-form-template.php</files>
  <action>
建立 Email 輸入表單模板，當 LINE 沒有提供 Email 時顯示：

**模板結構：**
```php
<?php
/**
 * Email 輸入表單模板
 *
 * 當 LINE ID Token 沒有 Email 時，在回調頁面顯示此表單
 *
 * 可用變數：
 * @var string $temp_key 暫存資料的 key
 * @var array $user_data LINE 用戶資料
 * @var string $reauth_url 強制重新授權 URL（AUTH-03）
 *
 * @package LineHub
 */

if (!defined('ABSPATH')) {
    exit;
}
?>
<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo('charset'); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><?php esc_html_e('完成註冊', 'line-hub'); ?></title>
    <?php wp_head(); ?>
    <style>
        /* 簡潔的表單樣式 */
        .line-hub-email-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 40px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .line-hub-email-form h2 {
            margin-bottom: 10px;
            color: #333;
        }
        .line-hub-email-form p {
            color: #666;
            margin-bottom: 20px;
        }
        .line-hub-email-form label {
            display: block;
            text-align: left;
            margin-bottom: 5px;
            color: #333;
        }
        .line-hub-email-form input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 16px;
        }
        .line-hub-email-form button {
            width: 100%;
            padding: 12px 24px;
            background: #06C755;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        .line-hub-email-form button:hover {
            background: #05b34d;
        }
        .line-hub-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 20px;
        }
        .line-hub-reauth-link {
            display: block;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
            text-decoration: none;
        }
        .line-hub-reauth-link:hover {
            color: #06C755;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="line-hub-email-form">
        <?php if (!empty($user_data['pictureUrl'])): ?>
            <img src="<?php echo esc_url($user_data['pictureUrl']); ?>"
                 alt="" class="line-hub-avatar">
        <?php endif; ?>

        <h2><?php esc_html_e('差一步就完成了！', 'line-hub'); ?></h2>

        <?php if (!empty($user_data['displayName'])): ?>
            <p><?php printf(
                esc_html__('嗨 %s，請輸入您的 Email 完成註冊。', 'line-hub'),
                esc_html($user_data['displayName'])
            ); ?></p>
        <?php else: ?>
            <p><?php esc_html_e('請輸入您的 Email 完成註冊。', 'line-hub'); ?></p>
        <?php endif; ?>

        <form method="POST" action="<?php echo esc_url(home_url('/line-hub/auth/email-submit')); ?>">
            <?php wp_nonce_field('line_hub_email_submit', '_wpnonce'); ?>
            <input type="hidden" name="temp_key" value="<?php echo esc_attr($temp_key); ?>">

            <label for="email"><?php esc_html_e('Email 地址', 'line-hub'); ?></label>
            <input type="email" name="email" id="email" required
                   placeholder="your@email.com">

            <button type="submit"><?php esc_html_e('繼續', 'line-hub'); ?></button>
        </form>

        <!-- AUTH-03: 強制重新授權連結 -->
        <a href="<?php echo esc_url($reauth_url); ?>" class="line-hub-reauth-link">
            <?php esc_html_e('回到 LINE 重新授權 Email 權限', 'line-hub'); ?>
        </a>
    </div>
    <?php wp_footer(); ?>
</body>
</html>
```

**設計要點：**
- 響應式設計，手機友善
- 使用 LINE 品牌綠色 (#06C755) 作為按鈕顏色
- 顯示用戶的 LINE 頭像（如果有）
- 顯示用戶的 LINE 顯示名稱打招呼
- **AUTH-03: 包含「重新授權」連結**，讓用戶可以回到 LINE 重新申請 Email 權限
- 使用 WordPress i18n 函式支援翻譯
- 載入 wp_head() 和 wp_footer() 確保相容性

**表單提交端點：**
`/line-hub/auth/email-submit`（需要在 Plugin 類別加入路由）

**重新授權連結：**
使用 OAuthClient::createReauthUrl() 產生，帶有 `prompt=consent` 參數
  </action>
  <verify>
檢查表單結構、安全性和重新授權連結：
```bash
grep -E "(wp_nonce_field|temp_key|email|form|button|reauth_url|reauth-link)" includes/auth/email-form-template.php
```
  </verify>
  <done>
Email 輸入表單模板完成，包含頭像顯示、個人化問候、安全的表單提交、以及 AUTH-03 強制重新授權連結
  </done>
</task>

<task type="auto">
  <name>Task 3: 加入 Email 提交路由並整合 LoginService</name>
  <files>includes/class-plugin.php, includes/auth/class-auth-callback.php</files>
  <action>
**Part A: 修改 `LineHub\Plugin` 類別，加入 Email 表單提交路由**

**1. 在 register_auth_routes() 加入新規則：**
```php
// Email 表單提交
add_rewrite_rule(
    '^line-hub/auth/email-submit/?$',
    'index.php?line_hub_auth=email-submit',
    'top'
);
```

**2. 在 handle_auth_requests() 加入處理：**
```php
public function handle_auth_requests(): void {
    $auth_action = get_query_var('line_hub_auth');

    if (empty($auth_action)) {
        return;
    }

    if ($auth_action === 'email-submit') {
        // 處理 Email 表單提交
        $login_service = new Services\LoginService();
        $login_service->handleEmailSubmit();
        exit;
    }

    // 處理認證請求（現有邏輯）
    $callback = new Auth\AuthCallback();
    $callback->handleRequest();
    exit;
}
```

---

**Part B: 回到 AuthCallback 類別，移除 placeholder 並加入實際呼叫**

開啟 `includes/auth/class-auth-callback.php`（Plan 03-02 產物），找到 `processCallback()` 方法中的 TODO placeholder，將其替換為實際的 LoginService 呼叫：

**移除：**
```php
// TODO: 由 Plan 03-03 實作 - 呼叫 LoginService::handleUser($user_data, $tokens)
// $login_service = new \LineHub\Services\LoginService();
// $login_service->handleUser($user_data, $tokens);

// 臨時處理：直接輸出調試資訊
wp_die('OAuth 流程完成，等待 LoginService 實作。User data: ' . print_r($user_data, true));
```

**替換為：**
```php
// 呼叫 LoginService 處理用戶登入/註冊
$login_service = new \LineHub\Services\LoginService();
$login_service->handleUser($user_data, $tokens);
```

**確認：**
- 確保 use statement 或完整 namespace 路徑正確
- 確保 $user_data 和 $tokens 變數在此作用域可用
  </action>
  <verify>
檢查路由和 LoginService 整合：
```bash
grep -E "(email-submit|handleEmailSubmit|LoginService|handleUser)" includes/class-plugin.php includes/auth/class-auth-callback.php
```
  </verify>
  <done>
Email 提交路由完成，AuthCallback 正確呼叫 LoginService::handleUser()，OAuth 流程完整串接
  </done>
</task>

</tasks>

<verification>
## 用戶流程測試

1. **新用戶登入（有 Email）：**
   - LINE 登入 → 取得 Email → 建立帳號 → 登入 → 重定向

2. **新用戶登入（無 Email）：**
   - LINE 登入 → 無 Email → 顯示表單（含重新授權連結）→ 輸入 Email → 建立帳號 → 登入
   - 或：點擊「重新授權」→ 回到 LINE → 授權 Email → 建立帳號 → 登入

3. **現有用戶登入：**
   - LINE 登入 → LINE UID 已綁定 → 直接登入 → 重定向

4. **Email 已存在：**
   - LINE 登入 → Email 已存在 → 綁定到現有帳號 → 登入

## 程式碼品質

1. 確認 namespace 正確（LineHub\Services）
2. 確認使用 sanitize_* 處理所有輸入
3. 確認使用 wp_nonce 防止 CSRF
4. 確認錯誤處理完整
</verification>

<success_criteria>
1. 新用戶可以成功建立 WordPress 帳號（subscriber 角色）
2. Username 格式為 line_xxx 或 user_xxx，保證唯一
3. Email 缺失時顯示友善的輸入表單
4. Email 表單包含「重新授權」連結（AUTH-03）
5. 登入完成後正確重定向
6. LINE 頭像和顯示名稱正確同步
7. 所有安全機制（nonce、sanitize）正確實作
8. AuthCallback 正確呼叫 LoginService（非 placeholder）
</success_criteria>

<output>
完成後建立 `.planning/phases/03-oauth-authentication/03-03-SUMMARY.md`
</output>
