---
phase: 02-user-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - includes/api/class-user-api.php
  - includes/class-plugin.php
autonomous: true

must_haves:
  truths:
    - "用戶可以透過 GET /line-hub/v1/user/binding 查詢自己的 LINE 綁定狀態"
    - "用戶可以透過 DELETE /line-hub/v1/user/binding 解除自己的 LINE 綁定"
    - "管理員可以透過 GET /line-hub/v1/user/{user_id}/binding 查詢任意用戶的綁定狀態"
    - "未登入用戶無法存取任何 API 端點"
    - "非管理員無法查詢其他用戶的綁定狀態"
  artifacts:
    - path: "includes/api/class-user-api.php"
      provides: "用戶綁定 REST API 端點"
      exports: ["User_API"]
      min_lines: 120
  key_links:
    - from: "includes/api/class-user-api.php"
      to: "includes/services/class-user-service.php"
      via: "static method calls"
      pattern: "UserService::"
    - from: "includes/class-plugin.php"
      to: "includes/api/class-user-api.php"
      via: "register_rest_routes()"
      pattern: "User_API.*register_routes"
---

<objective>
建立 User_API 類別，提供 LINE 綁定管理的 REST API 端點。

Purpose: 讓前端可以查詢和管理用戶的 LINE 綁定狀態，支援一般用戶和管理員的不同權限需求。
Output: `includes/api/class-user-api.php` - 完整的用戶綁定 API 類別
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-RESEARCH.md
@.planning/phases/02-user-management/02-01-SUMMARY.md

# Existing API patterns
@includes/api/class-settings-api.php
@includes/services/class-user-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 User_API 類別</name>
  <files>includes/api/class-user-api.php</files>
  <action>
建立 `User_API` 類別，實作以下 REST API 端點：

**1. GET /line-hub/v1/user/binding**
- Permission: `is_user_logged_in()`
- 回傳當前登入用戶的 LINE 綁定狀態
- Response 結構：
  ```json
  {
    "success": true,
    "data": {
      "is_bound": true,
      "binding": {
        "line_uid": "U***",  // 前4後4顯示，中間遮罩
        "display_name": "用戶名稱",
        "picture_url": "https://...",
        "email": "email@example.com",
        "email_verified": true,
        "linked_at": "2026-01-01 00:00:00",
        "source": "line_hub"  // 或 "nsl" 表示來自 NSL fallback
      }
    }
  }
  ```
- 未綁定時 `is_bound: false`, `binding: null`

**2. DELETE /line-hub/v1/user/binding**
- Permission: `is_user_logged_in()`
- 解除當前登入用戶的 LINE 綁定
- 只能解除自己的綁定，不能解除他人
- Response 結構：
  ```json
  {
    "success": true,
    "message": "LINE 綁定已解除"
  }
  ```

**3. GET /line-hub/v1/user/{user_id}/binding**
- Permission: `current_user_can('manage_options')`
- 管理員查詢指定用戶的綁定狀態
- Args 驗證：user_id 必須是正整數
- 如果用戶不存在，返回 404

權限檢查方法：
- `check_user_permission()`: 返回 `is_user_logged_in()`
- `check_admin_permission()`: 返回 `current_user_can('manage_options')`

輔助方法：
- `mask_line_uid(string $line_uid)`: 遮罩 LINE UID（顯示 Uxxxx...xxxx 格式）

重要實作細節：
- 命名空間：`LineHub\API`
- 使用 `\WP_REST_Response` 返回回應
- 所有端點都必須有 `permission_callback`
- 參考 `class-settings-api.php` 的實作模式
- 使用 `UserService::getBinding()` 和 `UserService::unlinkUser()` 處理邏輯
  </action>
  <verify>
PHP 語法檢查：
```bash
php -l includes/api/class-user-api.php
```
  </verify>
  <done>
User_API 類別存在且包含 register_routes 方法，定義三個端點（GET binding, DELETE binding, GET user binding），有正確的 permission_callback。
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 Plugin 類別註冊 User_API</name>
  <files>includes/class-plugin.php</files>
  <action>
更新 `Plugin::register_rest_routes()` 方法，加入 User_API 的註冊：

```php
// 註冊 User API
$user_api = new API\User_API();
$user_api->register_routes();
```

確保在 Settings_API 註冊之後加入，保持程式碼組織清晰。
  </action>
  <verify>
確認 Plugin 類別中有 User_API 的註冊：
```bash
grep -n "User_API" includes/class-plugin.php
```
  </verify>
  <done>
Plugin::register_rest_routes() 中有 User_API 的實例化和 register_routes() 呼叫。
  </done>
</task>

<task type="auto">
  <name>Task 3: 驗證程式碼結構完整性</name>
  <files>includes/api/class-user-api.php</files>
  <action>
驗證 User_API 類別的程式碼結構：

1. 確認有 `register_routes()` 方法
2. 確認 namespace 是 'line-hub/v1'
3. 確認有三個 `register_rest_route` 呼叫：
   - `/user/binding` (GET)
   - `/user/binding` (DELETE)
   - `/user/(?P<user_id>\d+)/binding` (GET)
4. 確認有 `permission_callback` 設定
5. 確認有呼叫 UserService 的靜態方法

這是程式碼結構驗證，確保所有必要元件都已實作。
  </action>
  <verify>
執行程式碼結構檢查：
```bash
# 檢查路由註冊
echo "=== Route registrations ===" && \
grep -c "register_rest_route" includes/api/class-user-api.php && \
echo "=== Permission callbacks ===" && \
grep -c "permission_callback" includes/api/class-user-api.php && \
echo "=== UserService calls ===" && \
grep -c "UserService::" includes/api/class-user-api.php
```
驗證：
- register_rest_route 至少 2 次呼叫（一次可能註冊多個 methods）
- permission_callback 至少 2 次
- UserService:: 至少 2 次呼叫
  </verify>
  <done>
程式碼結構檢查通過：有足夠的路由註冊、權限檢查和 UserService 呼叫。
  </done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過：`php -l includes/api/class-user-api.php`
2. 所有端點都有 permission_callback：`grep -c "permission_callback" includes/api/class-user-api.php` >= 2
3. User_API 在 Plugin 類別中註冊：`grep "User_API" includes/class-plugin.php`
4. 使用 UserService 處理業務邏輯：`grep "UserService::" includes/api/class-user-api.php`
5. LINE UID 有遮罩處理：`grep "mask" includes/api/class-user-api.php`
</verification>

<success_criteria>
- User_API 類別存在於 `includes/api/class-user-api.php`
- 三個 REST API 端點已註冊：GET/DELETE /user/binding, GET /user/{user_id}/binding
- 所有端點都有正確的 permission_callback
- Plugin::register_rest_routes() 有 User_API 的註冊
- User_API 呼叫 UserService 的靜態方法處理業務邏輯
- LINE UID 在回應中有遮罩處理
- PHP 語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-02-SUMMARY.md`
</output>
