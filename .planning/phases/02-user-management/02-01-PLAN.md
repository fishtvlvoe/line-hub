---
phase: 02-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-user-service.php
autonomous: true

must_haves:
  truths:
    - "系統可以透過 LINE UID 查詢對應的 WordPress User ID"
    - "系統可以透過 WordPress User ID 查詢 LINE 綁定狀態"
    - "系統可以建立新的 LINE 綁定關係"
    - "系統可以解除現有的 LINE 綁定關係"
    - "同一個 LINE UID 不能綁定多個 WordPress 帳號"
  artifacts:
    - path: "includes/services/class-user-service.php"
      provides: "LINE 用戶綁定服務核心邏輯"
      exports: ["UserService"]
      min_lines: 150
  key_links:
    - from: "includes/services/class-user-service.php"
      to: "wp_line_hub_users table"
      via: "$wpdb queries"
      pattern: "wpdb.*line_hub_users"
---

<objective>
建立 UserService 類別，實作 LINE 用戶綁定的核心邏輯。

Purpose: 提供可靠的用戶綁定管理功能，支援查詢、建立、更新和刪除綁定關係。
Output: `includes/services/class-user-service.php` - 完整的用戶服務類別
</objective>

<execution_context>
@/Users/fishtv/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fishtv/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-user-management/02-RESEARCH.md

# Existing codebase patterns
@includes/class-database.php
@includes/services/class-settings-service.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 UserService 類別基礎架構</name>
  <files>includes/services/class-user-service.php</files>
  <action>
建立 `UserService` 類別，包含以下靜態方法：

1. **getUserByLineUid(string $line_uid): ?int**
   - 透過 LINE UID 查詢對應的 WordPress User ID
   - 只查詢 `status = 'active'` 的記錄
   - 找不到返回 null

2. **getBinding(int $user_id): ?object**
   - 透過 WordPress User ID 查詢綁定狀態
   - 返回完整的綁定記錄（id, user_id, line_uid, display_name, picture_url, email, email_verified, status, created_at, updated_at）
   - 實作 NSL fallback：如果 `wp_line_hub_users` 找不到，嘗試查詢 `wp_social_users` 表（type='line'）
   - 找不到返回 null

3. **linkUser(int $user_id, string $line_uid, array $profile = []): bool|WP_Error**
   - 建立或更新 LINE 綁定關係
   - 檢查 LINE UID 是否已被其他帳號綁定（防止重複）
   - 如果用戶已有綁定且 LINE UID 不同，返回錯誤
   - $profile 參數接受 ['displayName', 'pictureUrl', 'email']
   - 成功返回 true，失敗返回 WP_Error

4. **unlinkUser(int $user_id): bool**
   - 解除 LINE 綁定（hard delete）
   - 觸發 `line_hub/user/before_unlink` action（傳入 $user_id）
   - 觸發 `line_hub/user/unlinked` action（傳入 $user_id）
   - 成功返回 true，失敗返回 false

5. **updateProfile(int $user_id, array $profile): bool**
   - 更新已綁定用戶的 LINE 資料
   - 只更新 display_name, picture_url, email, email_verified
   - 自動更新 updated_at 欄位

重要實作細節：
- 使用 `$wpdb->prefix . 'line_hub_users'` 作為表名
- 所有 SQL 都使用 `$wpdb->prepare()` 防止注入
- 使用 `current_time('mysql')` 處理時間欄位
- 命名空間：`LineHub\Services`
- 參考 RESEARCH.md 中的程式碼範例
  </action>
  <verify>
在外掛目錄執行 PHP 語法檢查：
```bash
php -l includes/services/class-user-service.php
```
確認無語法錯誤。
  </verify>
  <done>
UserService 類別存在且包含 getUserByLineUid、getBinding、linkUser、unlinkUser、updateProfile 五個靜態方法，PHP 語法正確。
  </done>
</task>

<task type="auto">
  <name>Task 2: 在 Plugin 類別中註冊 UserService</name>
  <files>includes/class-plugin.php</files>
  <action>
更新 `Plugin::init_services()` 方法，確保 UserService 可被其他模組使用：

1. 在 `init_services()` 中加入註釋說明 UserService 是靜態類別，不需要初始化
2. 確保 autoloader 可以正確載入 `LineHub\Services\UserService`

注意：由於 UserService 使用靜態方法，不需要特別初始化。這個 task 主要是確保程式碼結構清晰。
  </action>
  <verify>
確認 autoloader 可以載入 UserService：
```bash
grep -r "LineHub\\\\Services\\\\UserService" includes/
```
  </verify>
  <done>
Plugin 類別有清楚的註釋說明 UserService 的使用方式。
  </done>
</task>

</tasks>

<verification>
1. PHP 語法檢查通過：`php -l includes/services/class-user-service.php`
2. 類別包含所有必要方法（可用 grep 驗證）
3. SQL 查詢使用 `$wpdb->prepare()`（安全性檢查）
4. NSL fallback 邏輯存在
5. WordPress Hooks 觸發存在（before_unlink, unlinked）
</verification>

<success_criteria>
- UserService 類別存在於 `includes/services/class-user-service.php`
- 五個核心方法都已實作：getUserByLineUid, getBinding, linkUser, unlinkUser, updateProfile
- 所有 SQL 查詢都使用 `$wpdb->prepare()`
- NSL fallback 查詢存在於 getBinding 方法
- unlinkUser 觸發 WordPress action hooks
- PHP 語法檢查通過
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-01-SUMMARY.md`
</output>
