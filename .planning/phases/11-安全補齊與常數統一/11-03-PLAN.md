---
phase: 11-安全補齊與常數統一
plan: 03
type: execute
wave: 2
depends_on:
  - 11-02
files_modified:
  - includes/class-line-api-endpoints.php
  - includes/liff/class-liff-handler.php
  - includes/auth/class-oauth-client.php
  - includes/messaging/class-messaging-service.php
  - includes/admin/class-settings-page.php
autonomous: true
requirements:
  - CONST-01
  - CONST-02

must_haves:
  truths:
    - "用 grep -r 'https://api.line.me' includes/ 搜尋，結果為零（所有 LINE API URL 集中在常數類別）"
    - "LINE 登入（OAuth）流程正常運作"
    - "LIFF 登入流程正常運作"
    - "LINE 通知發送正常運作"
    - "後台連線測試正常運作"
  artifacts:
    - path: "includes/class-line-api-endpoints.php"
      provides: "LINE API URL 統一常數類別"
      contains: "class LineApiEndpoints"
    - path: "includes/auth/class-oauth-client.php"
      provides: "使用常數類別的 OAuth Client"
      contains: "LineApiEndpoints::"
    - path: "includes/messaging/class-messaging-service.php"
      provides: "使用常數類別的訊息服務"
      contains: "LineApiEndpoints::"
  key_links:
    - from: "includes/auth/class-oauth-client.php"
      to: "includes/class-line-api-endpoints.php"
      via: "引用 TOKEN_ENDPOINT, VERIFY_ENDPOINT, PROFILE_ENDPOINT"
      pattern: "LineApiEndpoints::"
    - from: "includes/messaging/class-messaging-service.php"
      to: "includes/class-line-api-endpoints.php"
      via: "引用 BOT_MESSAGE_ENDPOINT, BOT_INFO_ENDPOINT"
      pattern: "LineApiEndpoints::"
    - from: "includes/liff/class-liff-handler.php"
      to: "includes/class-line-api-endpoints.php"
      via: "引用 VERIFY_ENDPOINT, PROFILE_ENDPOINT"
      pattern: "LineApiEndpoints::"
    - from: "includes/admin/class-settings-page.php"
      to: "includes/class-line-api-endpoints.php"
      via: "引用 OAUTH_ACCESS_TOKEN_ENDPOINT"
      pattern: "LineApiEndpoints::"
---

<objective>
建立 LINE API URL 統一常數類別，並將所有散落在 4 個檔案中的硬編碼 URL 替換為常數引用

Purpose: 消除重複定義的 LINE API URL，集中管理方便未來 API 版本升級或端點變更
Output: 新的 LineApiEndpoints 常數類別 + 4 個檔案的 URL 替換
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-安全補齊與常數統一/11-02-SUMMARY.md
@includes/auth/class-oauth-client.php
@includes/liff/class-liff-handler.php
@includes/messaging/class-messaging-service.php
@includes/admin/class-settings-page.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 LineApiEndpoints 常數類別</name>
  <files>includes/class-line-api-endpoints.php</files>
  <action>
在 `includes/` 建立 `class-line-api-endpoints.php`，集中管理所有 LINE API URL。

依據目前散落在各檔案的 URL 掃描結果：

```php
<?php
/**
 * LINE API Endpoints 常數類別
 *
 * 集中管理所有 LINE API URL，避免重複定義
 *
 * @package LineHub
 */

namespace LineHub;

if (!defined('ABSPATH')) {
    exit;
}

/**
 * LINE API 端點常數
 *
 * 所有 LINE Platform API URL 統一在此管理。
 * 各服務類別透過 LineApiEndpoints::CONSTANT 引用，不要硬編碼 URL。
 */
class LineApiEndpoints {

    // ── OAuth 2.0 ──────────────────────────────────────
    /** Token 交換端點（authorization code → access token） */
    const OAUTH_TOKEN = 'https://api.line.me/oauth2/v2.1/token';

    /** Token 驗證端點（驗證 access token 或 ID token） */
    const OAUTH_VERIFY = 'https://api.line.me/oauth2/v2.1/verify';

    /** OAuth Access Token 端點（Channel Access Token v2.0，後台連線測試用） */
    const OAUTH_ACCESS_TOKEN = 'https://api.line.me/v2/oauth/accessToken';

    // ── User Profile ───────────────────────────────────
    /** 用戶 Profile 端點（取得 displayName, pictureUrl 等） */
    const PROFILE = 'https://api.line.me/v2/profile';

    // ── Messaging API ──────────────────────────────────
    /** Bot 訊息發送端點（push/reply/multicast/broadcast） */
    const BOT_MESSAGE = 'https://api.line.me/v2/bot/message';

    /** Bot 資訊端點（取得 Bot 基本資訊） */
    const BOT_INFO = 'https://api.line.me/v2/bot/info';
}
```

命名規則：
- 移除原檔案的 `_ENDPOINT` 後綴（因為類名已經叫 Endpoints）
- 使用分類前綴（OAUTH_、BOT_）
- 保留原始 URL 完全不變

Autoloader 命名：`LineApiEndpoints` → `class-line-api-endpoints.php`（符合既有 autoloader 規則）
  </action>
  <verify>
    <automated>php -l includes/class-line-api-endpoints.php && grep -c 'api.line.me' includes/class-line-api-endpoints.php | grep -q '6' && echo "PASS: 6 個 LINE API URL 集中管理"</automated>
  </verify>
  <done>LineApiEndpoints 類別存在，包含 6 個 LINE API URL 常數（OAUTH_TOKEN, OAUTH_VERIFY, OAUTH_ACCESS_TOKEN, PROFILE, BOT_MESSAGE, BOT_INFO）</done>
</task>

<task type="auto">
  <name>Task 2: 替換 4 個檔案中所有硬編碼的 LINE API URL</name>
  <files>
includes/auth/class-oauth-client.php
includes/liff/class-liff-handler.php
includes/messaging/class-messaging-service.php
includes/admin/class-settings-page.php
  </files>
  <action>
逐一替換每個檔案中的硬編碼 LINE API URL：

**1. includes/auth/class-oauth-client.php（3 個常數）**

移除類別內的 3 個 private const：
- `TOKEN_ENDPOINT = 'https://api.line.me/oauth2/v2.1/token'` → 使用 `LineApiEndpoints::OAUTH_TOKEN`
- `VERIFY_ENDPOINT = 'https://api.line.me/oauth2/v2.1/verify'` → 使用 `LineApiEndpoints::OAUTH_VERIFY`
- `PROFILE_ENDPOINT = 'https://api.line.me/v2/profile'` → 使用 `LineApiEndpoints::PROFILE`

在所有引用處替換：
- `self::TOKEN_ENDPOINT` → `\LineHub\LineApiEndpoints::OAUTH_TOKEN`
- `self::VERIFY_ENDPOINT` → `\LineHub\LineApiEndpoints::OAUTH_VERIFY`
- `self::PROFILE_ENDPOINT` → `\LineHub\LineApiEndpoints::PROFILE`

注意：OAuthClient 已在 `LineHub\Auth` namespace，引用時需要用完整路徑 `\LineHub\LineApiEndpoints` 或在檔案頂部加 `use LineHub\LineApiEndpoints;`。建議用 `use` 語句保持程式碼可讀性。

**2. includes/liff/class-liff-handler.php（2 個常數）**

移除類別內的 2 個 private const：
- `VERIFY_ENDPOINT = 'https://api.line.me/oauth2/v2.1/verify'` → 使用 `LineApiEndpoints::OAUTH_VERIFY`
- `PROFILE_ENDPOINT = 'https://api.line.me/v2/profile'` → 使用 `LineApiEndpoints::PROFILE`

在所有引用處替換（使用 `use \LineHub\LineApiEndpoints;`）：
- `self::VERIFY_ENDPOINT` → `LineApiEndpoints::OAUTH_VERIFY`
- `self::PROFILE_ENDPOINT` → `LineApiEndpoints::PROFILE`

注意：此檔案可能在 `LineHub\Liff` namespace，需要加 use 語句。

**3. includes/messaging/class-messaging-service.php（2 處）**

移除類別內的 1 個 private const：
- `API_ENDPOINT = 'https://api.line.me/v2/bot/message'` → 使用 `LineApiEndpoints::BOT_MESSAGE`

替換硬編碼 URL（第 369 行附近）：
- `'https://api.line.me/v2/bot/info'` → `LineApiEndpoints::BOT_INFO`

在所有引用處替換：
- `self::API_ENDPOINT` → `LineApiEndpoints::BOT_MESSAGE`

**4. includes/admin/class-settings-page.php（1 處）**

替換硬編碼 URL（第 170 行附近）：
- `'https://api.line.me/v2/oauth/accessToken'` → `LineApiEndpoints::OAUTH_ACCESS_TOKEN`

在檔案頂部加 `use LineHub\LineApiEndpoints;`（如果此檔案在 LineHub\Admin namespace）。

**替換後驗證**：`grep -r 'https://api.line.me' includes/` 結果必須為零。只有 `includes/class-line-api-endpoints.php` 內有定義。
  </action>
  <verify>
    <automated>php -l includes/auth/class-oauth-client.php && php -l includes/liff/class-liff-handler.php && php -l includes/messaging/class-messaging-service.php && php -l includes/admin/class-settings-page.php && RESULT=$(grep -r 'https://api.line.me' includes/ --include='*.php' | grep -v 'class-line-api-endpoints.php' | wc -l | tr -d ' ') && [ "$RESULT" = "0" ] && echo "PASS: 零硬編碼 LINE API URL"</automated>
  </verify>
  <done>4 個檔案中所有硬編碼的 LINE API URL 已替換為 LineApiEndpoints 常數引用，grep 搜尋結果為零</done>
</task>

</tasks>

<verification>
1. `php -l includes/class-line-api-endpoints.php` — 語法正確
2. `php -l includes/auth/class-oauth-client.php` — 語法正確
3. `php -l includes/liff/class-liff-handler.php` — 語法正確
4. `php -l includes/messaging/class-messaging-service.php` — 語法正確
5. `php -l includes/admin/class-settings-page.php` — 語法正確
6. `grep -r 'https://api.line.me' includes/ | grep -v 'class-line-api-endpoints.php'` — 結果為空（零硬編碼 URL）
7. `grep -c 'LineApiEndpoints::' includes/auth/class-oauth-client.php` — 至少 3 處引用
8. `grep -c 'LineApiEndpoints::' includes/liff/class-liff-handler.php` — 至少 2 處引用
9. `grep -c 'LineApiEndpoints::' includes/messaging/class-messaging-service.php` — 至少 2 處引用
</verification>

<success_criteria>
- LineApiEndpoints 常數類別存在且包含 6 個 LINE API URL
- 4 個檔案中的硬編碼 URL 全部替換為常數引用
- `grep -r 'https://api.line.me' includes/ | grep -v class-line-api-endpoints.php` 結果為空
- 所有 PHP 檔案語法正確
- Autoloader 可正確載入 LineApiEndpoints 類別
</success_criteria>

<output>
完成後建立 `.planning/phases/11-安全補齊與常數統一/11-03-SUMMARY.md`
</output>
