---
phase: 11-安全補齊與常數統一
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - uninstall.php
  - assets/index.php
  - assets/css/index.php
  - assets/images/index.php
  - assets/js/index.php
  - includes/index.php
  - includes/admin/index.php
  - includes/admin/tabs/index.php
  - includes/admin/views/index.php
  - includes/admin/views/partials/index.php
  - includes/api/index.php
  - includes/auth/index.php
  - includes/cli/index.php
  - includes/integration/index.php
  - includes/liff/index.php
  - includes/messaging/index.php
  - includes/services/index.php
  - includes/templates/index.php
  - includes/webhook/index.php
  - languages/index.php
  - tests/index.php
autonomous: true
requirements:
  - SEC-08
  - SEC-09

must_haves:
  truths:
    - "停用並刪除外掛後，wp_line_hub_users、wp_line_hub_webhooks、wp_line_hub_settings、wp_line_hub_notifications 資料表被完整清除"
    - "停用並刪除外掛後，所有 line_hub_* options 和相關 transients 被清除"
    - "停用並刪除外掛後，所有 line_hub_* user meta 被清除"
    - "直接訪問任何外掛子目錄的 URL 回傳空白頁而非目錄列表"
  artifacts:
    - path: "uninstall.php"
      provides: "外掛移除時的資料清理邏輯"
      contains: "WP_UNINSTALL_PLUGIN"
    - path: "includes/index.php"
      provides: "目錄瀏覽防護"
      contains: "Silence is golden"
  key_links:
    - from: "uninstall.php"
      to: "includes/class-database.php"
      via: "呼叫 Database::drop_tables()"
      pattern: "Database::drop_tables"
---

<objective>
建立 uninstall.php 清理邏輯和 20 個目錄的 index.php 防護檔

Purpose: 滿足 WordPress Plugin Handbook 基本安全要求 — 外掛移除時不留殘餘資料，且防止目錄瀏覽洩漏檔案結構
Output: uninstall.php + 20 個 index.php 防護檔
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/class-database.php
@line-hub.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 建立 uninstall.php — 外掛移除時完整清理所有資料</name>
  <files>uninstall.php</files>
  <action>
在外掛根目錄建立 `uninstall.php`，當用戶從 WordPress 後台刪除外掛時執行完整清理：

1. 安全檢查：`if (!defined('WP_UNINSTALL_PLUGIN')) { exit; }`
2. 載入 Database 類別（需要 autoload.php 或直接 require class-database.php）
3. 清理項目（按順序執行）：
   - 呼叫 `\LineHub\Database::drop_tables()` 刪除 4 張資料表（line_hub_users, line_hub_webhooks, line_hub_settings, line_hub_notifications）
   - 刪除 wp_options 中所有 line_hub_* 選項：
     - `line_hub_version`
     - `line_hub_db_version`
     - `line_hub_rewrite_version`
     - `line_hub_api_logs`
   - 刪除所有 line_hub_* transients：使用 `$wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_transient_line_hub_%' OR option_name LIKE '_transient_timeout_line_hub_%'")`
   - 刪除所有 site transients：`$wpdb->query("DELETE FROM {$wpdb->options} WHERE option_name LIKE '_site_transient_line_hub_%' OR option_name LIKE '_site_transient_timeout_line_hub_%'")`
   - 刪除所有 line_hub_* user meta：`$wpdb->query("DELETE FROM {$wpdb->usermeta} WHERE meta_key LIKE 'line_hub_%'")`

注意事項：
- 不要用 `require_once LINE_HUB_PATH`，因為 uninstall.php 執行時常數可能未定義。直接用 `__DIR__` 取得路徑。
- `Database::drop_tables()` 已經會刪除 `line_hub_db_version` 和 `line_hub_version`，但為保險仍在後面補刪。
- 使用 `$wpdb->query()` 直接操作，不依賴外掛的 Service 層（因為外掛已停用）。
  </action>
  <verify>
    <automated>php -l uninstall.php && grep -q 'WP_UNINSTALL_PLUGIN' uninstall.php && grep -q 'drop_tables' uninstall.php && grep -q 'line_hub_api_logs' uninstall.php && grep -q 'usermeta' uninstall.php && echo "PASS"</automated>
  </verify>
  <done>uninstall.php 存在且包含 WP_UNINSTALL_PLUGIN 安全檢查、4 張資料表刪除、options/transients/user meta 清理邏輯</done>
</task>

<task type="auto">
  <name>Task 2: 為 20 個目錄建立 index.php 防止目錄瀏覽</name>
  <files>
assets/index.php
assets/css/index.php
assets/images/index.php
assets/js/index.php
includes/index.php
includes/admin/index.php
includes/admin/tabs/index.php
includes/admin/views/index.php
includes/admin/views/partials/index.php
includes/api/index.php
includes/auth/index.php
includes/cli/index.php
includes/integration/index.php
includes/liff/index.php
includes/messaging/index.php
includes/services/index.php
includes/templates/index.php
includes/webhook/index.php
languages/index.php
tests/index.php
  </files>
  <action>
在以下 20 個目錄中建立 `index.php`，每個檔案內容完全相同：

```php
<?php
// Silence is golden.
```

目錄清單：
1. assets/
2. assets/css/
3. assets/images/
4. assets/js/
5. includes/
6. includes/admin/
7. includes/admin/tabs/
8. includes/admin/views/
9. includes/admin/views/partials/
10. includes/api/
11. includes/auth/
12. includes/cli/
13. includes/integration/
14. includes/liff/
15. includes/messaging/
16. includes/services/
17. includes/templates/
18. includes/webhook/
19. languages/
20. tests/

使用迴圈一次建立所有檔案，避免遺漏。建立後用 find 驗證數量。
  </action>
  <verify>
    <automated>find . -name "index.php" -not -path "./.git/*" -not -path "./.planning/*" | wc -l | tr -d ' ' | grep -q "20" && echo "PASS: 20 index.php files found"</automated>
  </verify>
  <done>20 個目錄各有 index.php，內容為 `<?php // Silence is golden.`，直接訪問任何子目錄 URL 回傳空白頁</done>
</task>

</tasks>

<verification>
1. `php -l uninstall.php` — 語法正確
2. `grep -c 'WP_UNINSTALL_PLUGIN' uninstall.php` — 安全檢查存在
3. `find . -name "index.php" -not -path "./.git/*" -not -path "./.planning/*" | wc -l` — 結果為 20
4. `grep -r "drop_tables" uninstall.php` — 資料表清理邏輯存在
</verification>

<success_criteria>
- uninstall.php 存在且語法正確，包含完整的資料清理邏輯（4 張資料表 + options + transients + user meta）
- 20 個目錄都有 index.php 防護檔
- 現有外掛功能不受影響（此 Plan 只新增檔案，不修改既有程式碼）
</success_criteria>

<output>
完成後建立 `.planning/phases/11-安全補齊與常數統一/11-01-SUMMARY.md`
</output>
