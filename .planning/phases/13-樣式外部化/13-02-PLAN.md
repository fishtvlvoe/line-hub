---
phase: 13-樣式外部化
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/css/liff-login.css
  - assets/css/liff-email.css
  - assets/css/auth-email-form.css
  - includes/liff/liff-template.php
  - includes/liff/liff-email-template.php
  - includes/auth/email-form-template.php
autonomous: true
requirements:
  - STYLE-02
must_haves:
  truths:
    - "LIFF 登入頁面（liff-template.php）載入獨立 CSS 檔案，頁面中無 <style> 區塊"
    - "LIFF Email 表單頁面（liff-email-template.php）載入獨立 CSS 檔案，頁面中無 <style> 區塊"
    - "OAuth Email 表單頁面（email-form-template.php）載入獨立 CSS 檔案，頁面中無 <style> 區塊"
    - "LIFF 在 LINE App 內開啟，登入頁面和 Email 表單的樣式正常顯示"
  artifacts:
    - path: "assets/css/liff-login.css"
      provides: "LIFF 登入頁面完整樣式（含 debug panel）"
      min_lines: 100
    - path: "assets/css/liff-email.css"
      provides: "LIFF Email 收集表單完整樣式"
      min_lines: 80
    - path: "assets/css/auth-email-form.css"
      provides: "OAuth Email 輸入表單完整樣式（含響應式）"
      min_lines: 80
  key_links:
    - from: "includes/liff/liff-template.php"
      to: "assets/css/liff-login.css"
      via: "<link> 標籤"
      pattern: "link.*liff-login\\.css"
    - from: "includes/liff/liff-email-template.php"
      to: "assets/css/liff-email.css"
      via: "<link> 標籤"
      pattern: "link.*liff-email\\.css"
    - from: "includes/auth/email-form-template.php"
      to: "assets/css/auth-email-form.css"
      via: "<link> 標籤"
      pattern: "link.*auth-email-form\\.css"
---

<objective>
將 3 個 LIFF/Auth 模板中的 `<style>` 區塊提取到獨立 CSS 檔案，透過 `<link>` 標籤載入。

Purpose: 滿足 STYLE-02 需求，LIFF/Email 模板樣式集中管理。這些是獨立 HTML 頁面（不在 WordPress 框架內），需要用 `<link>` 標籤載入而非 `wp_enqueue_style`。
Output: 3 個獨立 CSS 檔案 + 3 個零 `<style>` 區塊的模板。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@includes/liff/liff-template.php
@includes/liff/liff-email-template.php
@includes/auth/email-form-template.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 提取 3 個模板的 CSS 到獨立檔案</name>
  <files>
    assets/css/liff-login.css
    assets/css/liff-email.css
    assets/css/auth-email-form.css
  </files>
  <action>
    從 3 個模板檔案中提取 `<style>...</style>` 區塊的內容，建立對應的獨立 CSS 檔案。

    **1. `assets/css/liff-login.css`** — 從 `liff-template.php` 第 23-168 行提取：
    - 包含所有 LIFF 登入頁面樣式：reset、body 佈局、`.liff-container`、`.liff-logo`、`.liff-title`、`.liff-subtitle`、`.liff-spinner`、`@keyframes spin`、`.liff-status`、`.liff-error`、`.liff-retry`、`.liff-profile`、`.liff-success-icon`、`.liff-debug` 面板等
    - 原封不動提取，不修改任何 CSS 規則
    - 檔案開頭加標準註解：
    ```css
    /**
     * LIFF 登入頁面樣式
     *
     * 獨立 HTML 頁面用，透過 <link> 標籤載入
     *
     * @package LineHub
     * @since 3.0.0
     */
    ```

    **2. `assets/css/liff-email.css`** — 從 `liff-email-template.php` 第 29-155 行提取：
    - 包含所有 Email 收集表單樣式：reset、body 佈局、`.email-container`、`.profile-section`、`.profile-avatar`、`.profile-name`、`.profile-badge`、`.form-section`、`.form-label`、`.form-hint`、`.form-input`、`.form-error`、`.btn` 系列等
    - 原封不動提取，不修改任何 CSS 規則
    - 檔案開頭加標準註解

    **3. `assets/css/auth-email-form.css`** — 從 `email-form-template.php` 第 27-141 行提取：
    - 包含所有 OAuth Email 表單樣式：reset、body 佈局、`.line-hub-email-form` 系列、`.line-hub-avatar`、`.line-hub-reauth-link`、`.line-hub-site-name`、`@media (max-width: 480px)` 響應式等
    - 原封不動提取，不修改任何 CSS 規則
    - 檔案開頭加標準註解

    **關鍵注意事項：**
    - CSS 內容必須 100% 原封不動（包括選擇器名稱、屬性值、@keyframes、@media query）
    - 只移除 `<style>` 和 `</style>` 標籤，內部 CSS 不做任何修改
    - `liff-email-template.php` 第 119 行有動態 PHP：`display: <?php echo !empty($error) ? 'block' : 'none'; ?>;` — 這個 `.form-error` 的 display 由 PHP 動態控制，需要特殊處理：CSS 中設 `.form-error { display: none; }`（預設隱藏），模板中用 `class="form-error <?php echo !empty($error) ? 'is-visible' : ''; ?>"` + CSS `.form-error.is-visible { display: block; }` 來控制
  </action>
  <verify>
    <automated>wc -l assets/css/liff-login.css assets/css/liff-email.css assets/css/auth-email-form.css</automated>
    <manual>確認三個 CSS 檔案內容與原模板中的 style 區塊一致</manual>
  </verify>
  <done>三個獨立 CSS 檔案已建立，內容與原 style 區塊一致（僅 form-error 做了 class toggle 調整）</done>
</task>

<task type="auto">
  <name>Task 2: 更新 3 個模板改用 link 標籤載入 CSS</name>
  <files>
    includes/liff/liff-template.php
    includes/liff/liff-email-template.php
    includes/auth/email-form-template.php
  </files>
  <action>
    替換 3 個模板中的 `<style>...</style>` 區塊為 `<link>` 標籤。

    **1. `liff-template.php`：**
    - 移除第 23-168 行的 `<style>...</style>` 區塊
    - 在 `<head>` 中原 `<style>` 位置加入：
    ```php
    <link rel="stylesheet" href="<?php echo esc_url(plugins_url('assets/css/liff-login.css', dirname(dirname(__FILE__)))); ?>">
    ```
    - 注意路徑計算：`liff-template.php` 在 `includes/liff/` 下，需要往上兩層到外掛根目錄
    - 此模板是獨立 HTML 頁面，不使用 wp_enqueue_style

    **2. `liff-email-template.php`：**
    - 移除第 29-155 行的 `<style>...</style>` 區塊
    - 在 `<head>` 中原 `<style>` 位置加入：
    ```php
    <link rel="stylesheet" href="<?php echo esc_url(plugins_url('assets/css/liff-email.css', dirname(dirname(__FILE__)))); ?>">
    ```
    - 處理 `.form-error` 的動態顯示：
      - 舊：`<div class="form-error" id="emailError">` 搭配 CSS `display: <?php echo ... ?>;`
      - 新：`<div class="form-error <?php echo !empty($error) ? 'is-visible' : ''; ?>" id="emailError">`
      - CSS 中 `.form-error { display: none; }` + `.form-error.is-visible { display: block; }`

    **3. `email-form-template.php`：**
    - 移除第 27-141 行的 `<style>...</style>` 區塊
    - 在 `<head>` 中（`<?php wp_head(); ?>` 之後）加入：
    ```php
    <link rel="stylesheet" href="<?php echo esc_url(plugins_url('assets/css/auth-email-form.css', dirname(dirname(__FILE__)))); ?>">
    ```
    - 注意：此模板在 `includes/auth/` 下，同樣往上兩層
    - 此模板有 `wp_head()` 和 `wp_footer()`，但樣式仍用 `<link>` 直接載入以確保隔離

    **路徑驗證：**
    - `plugins_url('assets/css/xxx.css', dirname(dirname(__FILE__)))` 會正確產出 `/wp-content/plugins/line-hub/assets/css/xxx.css`
    - `dirname(dirname(__FILE__))` 從 `includes/liff/` 或 `includes/auth/` 往上兩層到外掛根目錄

    **版本控制：**
    - 在 `<link>` 標籤加版本參數避免快取：
    ```php
    <?php $lh_ver = defined('LINE_HUB_VERSION') ? LINE_HUB_VERSION : '1.0.0'; ?>
    <link rel="stylesheet" href="<?php echo esc_url(plugins_url('assets/css/liff-login.css', dirname(dirname(__FILE__)))); ?>?ver=<?php echo esc_attr($lh_ver); ?>">
    ```

    **不要動 JS 部分：**
    - `<script>` 區塊不在 Phase 13 範圍內，保持原樣
    - LIFF SDK 的 `<script src="...">` 保持原樣
  </action>
  <verify>
    <automated>grep -rn '<style' includes/liff/ includes/auth/ | grep -v 'ABSPATH' | wc -l</automated>
    <manual>結果應為 0。用 curl 或瀏覽器開啟 LIFF 頁面確認 CSS 正確載入</manual>
  </verify>
  <done>三個模板零 style 區塊，CSS 透過 link 標籤載入，頁面樣式正常</done>
</task>

</tasks>

<verification>
1. `grep -rn '<style' includes/liff/ includes/auth/` — 結果為零
2. 在 LINE App 內開啟 LIFF 登入頁面（`https://liff.line.me/2008622068-iU4Z1lk4`），確認樣式正常
3. 觸發 Email 收集表單流程，確認表單頁面樣式正常
4. 檢查三個 CSS 檔案是否可透過瀏覽器直接存取（`/wp-content/plugins/line-hub/assets/css/liff-login.css`）
</verification>

<success_criteria>
1. 三個 LIFF/Auth 模板中零 `<style>` 區塊
2. 三個獨立 CSS 檔案存在且內容正確
3. LIFF 登入頁面和 Email 表單在 LINE App 內樣式正常顯示
</success_criteria>

<output>
After completion, create `.planning/phases/13-樣式外部化/13-02-SUMMARY.md`
</output>
