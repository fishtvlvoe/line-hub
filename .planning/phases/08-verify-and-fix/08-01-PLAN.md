---
phase: 08-verify-and-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/api/class-public-api.php
  - includes/services/class-integration-hooks.php
  - includes/admin/class-users-column.php
autonomous: true
requirements: [VERIFY-05]

must_haves:
  truths:
    - "API Key 認證使用 hash_equals() 進行恆定時間比較，防止 Timing Attack"
    - "broadcast 端點和 Hook 拒絕超過 100 個 user_id 的請求"
    - "REST API send_text/flex/broadcast 成功時回傳 success:true（修復 (bool)[] = false bug）"
    - "WordPress 用戶列表頁面載入時，SHOW TABLES 查詢次數從 150 次降為 3 次（50 個用戶場景）"
  artifacts:
    - path: "includes/api/class-public-api.php"
      provides: "hash_equals 認證、broadcast 100 人上限、回應格式修復"
      contains: "hash_equals"
    - path: "includes/services/class-integration-hooks.php"
      provides: "broadcast Hook 100 人上限"
      contains: "exceeds limit"
    - path: "includes/admin/class-users-column.php"
      provides: "table_exists 靜態快取"
      contains: "table_cache"
  key_links:
    - from: "includes/api/class-public-api.php:authenticate()"
      to: "hash_equals()"
      via: "替換 !== 比較為 hash_equals()"
      pattern: "hash_equals\\(\\$stored_hash"
    - from: "includes/api/class-public-api.php:send_broadcast()"
      to: "WP_REST_Response(400)"
      via: "count 檢查 > 100"
      pattern: "count\\(\\$user_ids\\) > 100"
    - from: "includes/api/class-public-api.php:send_text()"
      to: "is_wp_error()"
      via: "替換 (bool)$result 為 !is_wp_error()"
      pattern: "is_wp_error\\(\\$result\\)"
---

<objective>
修復 Phase 8 研究中發現的所有安全問題和程式碼 Bug

Purpose: 在進行端到端驗證之前，先修正所有已知問題，確保驗證時測試的是正確的程式碼
Output: 三個修復後的 PHP 檔案，所有安全問題和已知 Bug 已解決
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-verify-and-fix/08-RESEARCH.md

# 關鍵原始碼
@includes/api/class-public-api.php
@includes/services/class-integration-hooks.php
@includes/admin/class-users-column.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: 修復 PublicAPI — hash_equals、broadcast 上限、回應格式</name>
  <files>includes/api/class-public-api.php</files>
  <action>
修改 `includes/api/class-public-api.php`，共 4 處修復：

**1. authenticate() — hash_equals（VERIFY-04）**

第 93 行，將：
```php
if (empty($stored_hash) || wp_hash($key) !== $stored_hash) {
```
改為：
```php
if (empty($stored_hash) || !hash_equals($stored_hash, wp_hash($key))) {
```
注意 `hash_equals()` 的參數順序：第一個是已知值（stored），第二個是用戶輸入值。

**2. send_broadcast() — 100 人上限（VERIFY-05）**

在第 205 行 `$user_ids = array_filter(...)` 之後、第 206 行 `if (empty($user_ids))` 之前，插入：
```php
// 安全限制：單次 broadcast 最多 100 個用戶
if (count($user_ids) > 100) {
    return new \WP_REST_Response(
        ['success' => false, 'message' => 'user_ids 數量超過上限（最多 100 個）'],
        400
    );
}
```

**3. send_text() — 回應格式修復**

第 133-136 行，將：
```php
return new \WP_REST_Response([
    'success' => (bool) $result,
    'message' => $result ? '訊息已發送' : '發送失敗',
]);
```
改為：
```php
$success = !is_wp_error($result);
return new \WP_REST_Response([
    'success' => $success,
    'message' => $success ? '訊息已發送' : '發送失敗',
]);
```

**4. send_flex() 和 send_broadcast() — 同樣的回應格式修復**

send_flex() 第 174-177 行，同樣改法：
```php
$success = !is_wp_error($result);
return new \WP_REST_Response([
    'success' => $success,
    'message' => $success ? 'Flex 訊息已發送' : '發送失敗',
]);
```

send_broadcast() 第 217-221 行：
```php
$success = !is_wp_error($result);
return new \WP_REST_Response([
    'success' => $success,
    'message' => $success ? '批量訊息已發送' : '發送失敗',
    'count'   => count($user_ids),
]);
```

**為什麼用 `!is_wp_error()` 而不是 `(bool) $result`：**
LINE API 成功回應是 `{}`（JSON 空物件），PHP 解碼後是空陣列 `[]`，而 `(bool) [] = false`。所以成功發送時 `(bool) $result` 是 false，導致 API 回報「發送失敗」。`is_wp_error()` 正確區分成功（array）和失敗（WP_Error）。
  </action>
  <verify>
    <automated>grep -n 'hash_equals' includes/api/class-public-api.php && grep -n 'is_wp_error' includes/api/class-public-api.php && grep -c 'count.*user_ids.*100' includes/api/class-public-api.php</automated>
    <manual>確認 hash_equals 出現 1 次、is_wp_error 出現 3 次、broadcast 上限檢查出現 1 次</manual>
  </verify>
  <done>PublicAPI 的 4 處修復完成：hash_equals 認證、broadcast 100 人上限、3 個端點的回應格式修正</done>
</task>

<task type="auto">
  <name>Task 2: 修復 IntegrationHooks broadcast 上限 + UsersColumn N+1 快取</name>
  <files>includes/services/class-integration-hooks.php, includes/admin/class-users-column.php</files>
  <action>
**1. IntegrationHooks::handle_broadcast() — 100 人上限（VERIFY-05）**

修改 `includes/services/class-integration-hooks.php`。

在第 121 行 `$user_ids = array_filter(...)` 之後、第 123 行 `if (empty($user_ids))` 之前，插入：
```php
// 安全限制：單次 broadcast 最多 100 個用戶
if (count($user_ids) > 100) {
    error_log("[LineHub] handle_broadcast: REJECTED — user_ids count " . count($user_ids) . " exceeds limit 100");
    return;
}
```

**2. UsersColumn::table_exists() — 靜態快取**

修改 `includes/admin/class-users-column.php`。

在 class 頂部（`public static function init()` 之前）加入靜態屬性：
```php
/**
 * 資料表存在性快取
 * @var array<string, bool>
 */
private static array $table_cache = [];
```

修改 `table_exists()` 方法（第 122-126 行），改為：
```php
private static function table_exists(string $table_name): bool {
    if (isset(self::$table_cache[$table_name])) {
        return self::$table_cache[$table_name];
    }

    global $wpdb;
    $result = $wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $table_name));
    self::$table_cache[$table_name] = ($result === $table_name);

    return self::$table_cache[$table_name];
}
```

這樣每個 table 只查一次，50 個用戶從 150 次 SHOW TABLES 降為 3 次。
  </action>
  <verify>
    <automated>grep -n 'exceeds limit' includes/services/class-integration-hooks.php && grep -n 'table_cache' includes/admin/class-users-column.php</automated>
    <manual>確認 IntegrationHooks 有 broadcast 上限檢查、UsersColumn 有靜態快取</manual>
  </verify>
  <done>IntegrationHooks broadcast 上限和 UsersColumn N+1 快取修復完成</done>
</task>

</tasks>

<verification>
修復後的程式碼驗證清單：

1. `grep -c 'hash_equals' includes/api/class-public-api.php` = 1
2. `grep -c 'is_wp_error' includes/api/class-public-api.php` = 3（send_text、send_flex、send_broadcast）
3. `grep -c 'count.*100' includes/api/class-public-api.php` = 1
4. `grep -c 'exceeds limit' includes/services/class-integration-hooks.php` = 1
5. `grep -c 'table_cache' includes/admin/class-users-column.php` >= 3（宣告 + 讀取 + 寫入）
6. `(bool) $result` 不再出現在 send_text/flex/broadcast 的回應中
</verification>

<success_criteria>
- hash_equals() 取代 !== 字串比較（VERIFY-04）
- REST API broadcast 超過 100 user_ids 回傳 HTTP 400（VERIFY-05）
- Hook broadcast 超過 100 user_ids 記錄錯誤並拒絕執行（VERIFY-05）
- 三個訊息端點的 success 欄位使用 is_wp_error() 正確判斷（額外發現修復）
- UsersColumn 的 table_exists 有靜態快取（額外發現修復）
</success_criteria>

<output>
完成後建立 `.planning/phases/08-verify-and-fix/08-01-SUMMARY.md`
</output>
