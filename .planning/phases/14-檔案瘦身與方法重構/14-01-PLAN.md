---
phase: 14-檔案瘦身與方法重構
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/liff/class-liff-handler.php
  - includes/liff/class-liff-user-processor.php
  - includes/services/class-settings-service.php
  - includes/services/class-settings-schema.php
  - includes/services/class-user-service.php
  - includes/services/class-user-profile-manager.php
  - includes/class-plugin.php
  - includes/class-plugin-routes.php
autonomous: true
requirements:
  - SIZE-01
  - SIZE-02
must_haves:
  truths:
    - "4 個 500+ 行檔案全部降到 300 行以內"
    - "新提取的 4 個類別全部在 300 行以內"
    - "Autoloader 自動載入所有新類別（不需修改 autoload.php）"
    - "原有 public 方法簽名不變，外部呼叫者不受影響"
  artifacts:
    - path: "includes/liff/class-liff-user-processor.php"
      provides: "LIFF 用戶處理邏輯（驗證、建帳、遷移）"
      min_lines: 150
    - path: "includes/services/class-settings-schema.php"
      provides: "設定 Schema 定義陣列"
      min_lines: 200
    - path: "includes/services/class-user-profile-manager.php"
      provides: "用戶 Profile 更新、批次查詢、NSL 遷移"
      min_lines: 150
    - path: "includes/class-plugin-routes.php"
      provides: "Auth 路由、LIFF 路由的註冊和處理"
      min_lines: 150
  key_links:
    - from: "includes/liff/class-liff-handler.php"
      to: "includes/liff/class-liff-user-processor.php"
      via: "use statement + method delegation"
      pattern: "LiffUserProcessor"
    - from: "includes/services/class-settings-service.php"
      to: "includes/services/class-settings-schema.php"
      via: "use statement + static method call"
      pattern: "SettingsSchema"
---

<objective>
將 4 個 500+ 行的 Class 檔案拆分為更小的類別，每個檔案控制在 300 行以內。

Purpose: 滿足 SIZE-01（零 500+ 行違規）和 SIZE-02（零 300+ 行違規），降低單一檔案複雜度。
Output: 4 個瘦身後的原始檔案 + 4 個新提取的類別檔案。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-檔案瘦身與方法重構/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 拆分 LiffHandler（678→~280）— 提取 LiffUserProcessor</name>
  <files>
    includes/liff/class-liff-handler.php
    includes/liff/class-liff-user-processor.php
  </files>
  <action>
    1. 建立 `includes/liff/class-liff-user-processor.php`，命名空間 `LineHub\Liff`

    **搬移以下方法到 LiffUserProcessor：**
    - `handleVerify()` 的核心邏輯（access token 驗證 → 取 profile → 查找/建立用戶 → 登入）→ 改名為 `processVerification(string $access_token, string $redirect): void`
    - `handleEmailSubmit()` 的核心邏輯 → 改名為 `processEmailSubmit(string $redirect): void`
    - `createNewUser()` → 保持原名
    - `migrateBindingIfNeeded()` → 保持原名
    - `loginAndRedirect()` → 保持原名
    - `verifyAccessToken()` → 保持原名
    - `getProfile()` → 保持原名

    **LiffUserProcessor 的 constructor：**
    ```php
    public function __construct() {
        // 不需要依賴注入，所有 service 都是 static 方法
    }
    ```

    2. 修改 `class-liff-handler.php`：
    - 加入 `use LineHub\Liff\LiffUserProcessor;`
    - `handleVerify()` 瘦身為：建立 LiffUserProcessor 實例，呼叫 `processVerification()`
    - `handleEmailSubmit()` 瘦身為：建立 LiffUserProcessor 實例，呼叫 `processEmailSubmit()`
    - 刪除已搬移的 private 方法
    - 保留：`handleRequest()`、`renderPage()`、`renderEmailForm()`、`resolveRedirectUrl()`、`respondError()`

    **目標行數：**
    - LiffHandler: ~280 行（路由分發 + 頁面渲染）
    - LiffUserProcessor: ~250 行（用戶處理 + API 呼叫）
  </action>
  <verify>
    <automated>wc -l includes/liff/class-liff-handler.php includes/liff/class-liff-user-processor.php && php -l includes/liff/class-liff-handler.php && php -l includes/liff/class-liff-user-processor.php</automated>
    <manual>兩個檔案都在 300 行以內，PHP syntax check 通過</manual>
  </verify>
  <done>LiffHandler 降到 300 行以內，LiffUserProcessor 建立完成且 syntax 正確</done>
</task>

<task type="auto">
  <name>Task 2: 拆分 SettingsService（653→~290）— 提取 SettingsSchema</name>
  <files>
    includes/services/class-settings-service.php
    includes/services/class-settings-schema.php
  </files>
  <action>
    1. 建立 `includes/services/class-settings-schema.php`，命名空間 `LineHub\Services`

    **搬移內容：**
    - 整個 `$schema` 靜態陣列（原檔第 22-281 行，約 260 行）→ 改為 `SettingsSchema::DEFINITIONS` 常數或 `SettingsSchema::getAll()` 靜態方法
    - `get_schema()` 方法
    - `get_all_groups()` 方法

    **SettingsSchema 類別結構：**
    ```php
    class SettingsSchema {
        private static array $schema = [ /* 原本的 schema 定義 */ ];

        public static function getAll(): array { return self::$schema; }
        public static function getGroup(string $group): ?array { return self::$schema[$group] ?? null; }
        public static function getField(string $group, string $key): ?array { ... }
        public static function getAllGroups(): array { return array_keys(self::$schema); }
    }
    ```

    2. 修改 `class-settings-service.php`：
    - 加入 `use LineHub\Services\SettingsSchema;`
    - 刪除 `$schema` 屬性
    - 所有 `self::$schema` 參照改為 `SettingsSchema::getAll()` 或 `SettingsSchema::getGroup($group)`
    - 刪除 `get_schema()` 和 `get_all_groups()`，改為委派到 SettingsSchema

    **目標行數：**
    - SettingsService: ~290 行（CRUD + 加密 + 驗證）
    - SettingsSchema: ~280 行（Schema 定義 + 查詢）
  </action>
  <verify>
    <automated>wc -l includes/services/class-settings-service.php includes/services/class-settings-schema.php && php -l includes/services/class-settings-service.php && php -l includes/services/class-settings-schema.php</automated>
    <manual>兩個檔案都在 300 行以內，PHP syntax check 通過</manual>
  </verify>
  <done>SettingsService 降到 300 行以內，SettingsSchema 建立完成</done>
</task>

<task type="auto">
  <name>Task 3: 拆分 UserService（549→~280）— 提取 UserProfileManager</name>
  <files>
    includes/services/class-user-service.php
    includes/services/class-user-profile-manager.php
  </files>
  <action>
    1. 建立 `includes/services/class-user-profile-manager.php`，命名空間 `LineHub\Services`

    **搬移以下方法到 UserProfileManager：**
    - `updateProfile()` (79 行) — 用戶 profile 更新（display_name, picture_url, avatar）
    - `getBindingsBatch()` — 批次查詢綁定
    - `countLinkedUsers()` — 統計綁定用戶數
    - `detectNslColumns()` (43 行) — NSL 欄位偵測（private → private in new class）
    - `getDisplayName()` — 取得顯示名稱
    - `getPictureUrl()` — 取得頭像 URL

    **UserService 保留：**
    - `getUserByLineUid()` — 核心查詢
    - `hasDirectBinding()` — 綁定狀態檢查
    - `getBinding()` — 取得綁定資料
    - `linkUser()` (86 行) — 綁定用戶（核心方法，留在 UserService）
    - `unlinkUser()` — 解除綁定
    - `isLinked()` — 快速檢查
    - `getLineUid()` — 取得 LINE UID

    2. 修改 `class-user-service.php`：
    - 加入委派方法（thin wrapper），保持向後相容：
    ```php
    public static function updateProfile(int $user_id, array $profile): bool {
        return UserProfileManager::updateProfile($user_id, $profile);
    }
    ```
    - 或者直接刪除委派，讓呼叫者改用 UserProfileManager（grep 確認呼叫者再決定）

    **目標行數：**
    - UserService: ~280 行（核心 link/unlink/query）
    - UserProfileManager: ~250 行（profile 更新 + 批次 + NSL）
  </action>
  <verify>
    <automated>wc -l includes/services/class-user-service.php includes/services/class-user-profile-manager.php && php -l includes/services/class-user-service.php && php -l includes/services/class-user-profile-manager.php</automated>
    <manual>兩個檔案都在 300 行以內，PHP syntax check 通過，grep 確認所有呼叫者仍能正確存取</manual>
  </verify>
  <done>UserService 降到 300 行以內，UserProfileManager 建立完成</done>
</task>

<task type="auto">
  <name>Task 4: 拆分 Plugin（513→~280）— 提取 PluginRoutes</name>
  <files>
    includes/class-plugin.php
    includes/class-plugin-routes.php
  </files>
  <action>
    1. 建立 `includes/class-plugin-routes.php`，命名空間 `LineHub`

    **搬移以下方法到 PluginRoutes：**
    - `register_auth_routes()` — Auth 路由註冊（rewrite rules + query vars）
    - `handle_auth_requests()` — Auth 請求處理
    - `register_liff_routes()` — LIFF 路由註冊
    - `intercept_liff_requests()` — LIFF 請求攔截
    - `handle_liff_requests()` — LIFF 請求處理
    - `maybe_flush_rewrite_rules()` — Rewrite rules flush

    **PluginRoutes 結構：**
    ```php
    class PluginRoutes {
        public function register(): void {
            // 將所有路由相關 hooks 註冊集中在這裡
        }
        // 上述 6 個方法
    }
    ```

    2. 修改 `class-plugin.php`：
    - 在 `register_hooks()` 中建立 `PluginRoutes` 實例並呼叫 `register()`
    - 刪除已搬移的 6 個方法
    - 保留：singleton pattern、init()、load_dependencies()、init_services()、on_init()、register_rest_routes()、register_admin_menu()、enqueue_admin_assets()、enqueue_frontend_assets()、override_avatar_with_line()、render_profile_binding_section()、process_webhook_events()

    **目標行數：**
    - Plugin: ~280 行（singleton + init + hooks + assets + webhook）
    - PluginRoutes: ~220 行（路由註冊 + 處理）
  </action>
  <verify>
    <automated>wc -l includes/class-plugin.php includes/class-plugin-routes.php && php -l includes/class-plugin.php && php -l includes/class-plugin-routes.php</automated>
    <manual>兩個檔案都在 300 行以內，PHP syntax check 通過</manual>
  </verify>
  <done>Plugin 降到 300 行以內，PluginRoutes 建立完成</done>
</task>

<task type="auto">
  <name>Task 5: 驗證 — 全部 4 對檔案行數 + 語法 + 呼叫鏈</name>
  <files>
    includes/liff/class-liff-handler.php
    includes/services/class-settings-service.php
    includes/services/class-user-service.php
    includes/class-plugin.php
  </files>
  <action>
    1. 行數驗證：
    ```bash
    wc -l includes/liff/class-liff-handler.php includes/liff/class-liff-user-processor.php includes/services/class-settings-service.php includes/services/class-settings-schema.php includes/services/class-user-service.php includes/services/class-user-profile-manager.php includes/class-plugin.php includes/class-plugin-routes.php
    ```
    所有 8 個檔案必須 ≤ 300 行。

    2. PHP syntax check：
    ```bash
    for f in includes/liff/class-liff-user-processor.php includes/services/class-settings-schema.php includes/services/class-user-profile-manager.php includes/class-plugin-routes.php; do php -l "$f"; done
    ```

    3. 呼叫鏈驗證：
    ```bash
    grep -rn "LiffHandler\|LiffUserProcessor" includes/ --include="*.php"
    grep -rn "SettingsService\|SettingsSchema" includes/ --include="*.php"
    grep -rn "UserService\|UserProfileManager" includes/ --include="*.php"
    grep -rn "PluginRoutes" includes/ --include="*.php"
    ```
    確認所有 use 語句和呼叫都正確指向新/舊類別。

    4. 零 500+ 行違規確認：
    ```bash
    find includes/ -name "*.php" -exec wc -l {} + | sort -rn | head -5
    ```
    第一行（total 除外）必須 < 500。
  </action>
  <verify>
    <automated>find includes/ -name "*.php" | xargs wc -l | sort -rn | awk 'NR==2{if($1>500) print "FAIL: "$2" has "$1" lines"; else print "PASS: max file is "$1" lines"}'</automated>
    <manual>零 500+ 行檔案，所有新類別 PHP syntax 通過</manual>
  </verify>
  <done>4 個 500+ 行檔案全部拆分完成，零 500+ 行違規，autoloader 正確載入所有新類別</done>
</task>

</tasks>

<verification>
1. `find includes/ -name "*.php" -exec wc -l {} + | sort -rn | head -10` — 零 500+ 行檔案
2. `php -l` 對所有 8 個相關檔案 — 語法正確
3. `grep -rn "SettingsSchema\|LiffUserProcessor\|UserProfileManager\|PluginRoutes" includes/` — use 語句和呼叫正確
</verification>

<success_criteria>
1. 4 個原始 500+ 行檔案全部降到 300 行以內
2. 4 個新類別全部在 300 行以內且 PHP syntax 正確
3. Autoloader 自動載入新類別（不需修改 autoload.php）
4. 原有 public API 不變，呼叫者不受影響
</success_criteria>

<output>
After completion, create `.planning/phases/14-檔案瘦身與方法重構/14-01-SUMMARY.md`
</output>
