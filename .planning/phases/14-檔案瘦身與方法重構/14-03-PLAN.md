---
phase: 14-檔案瘦身與方法重構
plan: 03
type: execute
wave: 2
depends_on: [14-01, 14-02]
files_modified:
  - includes/class-auto-updater.php
  - includes/services/class-content-service.php
  - includes/admin/tabs/class-developer-tab.php
  - includes/webhook/class-event-dispatcher.php
  - includes/webhook/class-webhook-receiver.php
  - includes/integration/class-fluent-cart-connector.php
  - includes/auth/class-session-transfer.php
  - includes/auth/class-auth-callback.php
  - includes/cli/class-migrate-avatars-command.php
  - includes/liff/class-liff-user-processor.php
  - includes/services/class-login-service.php
  - includes/services/class-user-service.php
  - includes/class-plugin.php
autonomous: true
requirements:
  - METHOD-01
must_haves:
  truths:
    - "所有 PHP 方法 ≤ 50 行（零違規）"
    - "原有功能行為不變"
  artifacts: []
  key_links: []
---

<objective>
將所有超過 50 行的方法縮短到 50 行以內，完成 Phase 14 的方法重構目標。

Purpose: 滿足 METHOD-01（零 50+ 行方法違規），每個方法只做一件事。
Output: 13+ 個檔案中的 ~26 個長方法全部重構完成。

注意：Plan 14-01 和 14-02 的檔案拆分已在 Wave 1 完成。部分長方法可能已在拆分過程中自然縮短。本 Plan 處理所有剩餘的長方法。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-檔案瘦身與方法重構/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 掃描 Wave 1 後的長方法現況</name>
  <files>
    includes/
  </files>
  <action>
    執行長方法掃描腳本，找出 Plan 14-01 和 14-02 完成後仍然超過 50 行的方法：

    ```python
    # 同 RESEARCH 中使用的掃描腳本
    # 搜尋所有 includes/ 下的 PHP 方法，找出 > 50 行的
    ```

    記錄所有仍超標的方法清單，作為後續 task 的工作範圍。

    預計仍需處理的方法（在 < 300 行檔案中，Plan 01/02 不會觸及）：
    - class-auto-updater.php: check_update() 93 行、plugin_info() 54 行
    - class-content-service.php: downloadAndUpload() 85 行
    - class-developer-tab.php: get_api_endpoints() 82 行、get_hooks_data() 54 行
    - class-event-dispatcher.php: dispatchEvent() 65 行、dispatchMessage() 53 行
    - class-webhook-receiver.php: handleWebhook() 63 行
    - class-fluent-cart-connector.php: renderBindingSection() 63 行
    - class-session-transfer.php: handleExchange() 63 行
    - class-auth-callback.php: processCallback() 58 行
    - class-migrate-avatars-command.php: run() 64 行

    加上 Plan 01/02 拆分後仍可能超標的方法：
    - class-liff-user-processor.php: processVerification() (從 handleVerify 128 行拆來)
    - class-user-service.php: linkUser() 86 行
    - class-plugin.php: override_avatar_with_line() 60 行
  </action>
  <verify>
    <automated>python3 -c "掃描腳本" 2>&1 | head -30</automated>
    <manual>確認所有 > 50 行方法都在清單中</manual>
  </verify>
  <done>長方法清單建立完成，作為後續重構的工作範圍</done>
</task>

<task type="auto">
  <name>Task 2: 重構 Auto-Updater 長方法</name>
  <files>
    includes/class-auto-updater.php
  </files>
  <action>
    **check_update() 93 行 → 拆成 3 個方法：**
    - `check_update()` (~30 行) — 主流程：檢查快取 → 查 API → 比較版本
    - `fetchRemoteVersion(): ?object` (~25 行) — GitHub API 查詢最新 release
    - `buildUpdateObject(object $release): object` (~25 行) — 組裝 WP 更新物件

    **plugin_info() 54 行 → 拆成 2 個方法：**
    - `plugin_info()` (~25 行) — 主流程
    - `buildPluginInfoObject(object $release): object` (~20 行) — 組裝外掛資訊
  </action>
  <verify>
    <automated>php -l includes/class-auto-updater.php</automated>
    <manual>所有方法 ≤ 50 行</manual>
  </verify>
  <done>Auto-Updater 方法全部 ≤ 50 行</done>
</task>

<task type="auto">
  <name>Task 3: 重構 Webhook + Auth 長方法</name>
  <files>
    includes/webhook/class-event-dispatcher.php
    includes/webhook/class-webhook-receiver.php
    includes/auth/class-session-transfer.php
    includes/auth/class-auth-callback.php
  </files>
  <action>
    **EventDispatcher:**
    - `dispatchEvent()` 65 行 → `dispatchEvent()` (~30 行) + `routeEvent(string $type, array $event): void` (~25 行)
    - `dispatchMessage()` 53 行 → `dispatchMessage()` (~25 行) + `handleTextMessage(array $event): void` (~20 行)

    **WebhookReceiver:**
    - `handleWebhook()` 63 行 → `handleWebhook()` (~25 行) + `validateAndParsePayload(\WP_REST_Request $request): ?array` (~25 行)

    **SessionTransfer:**
    - `handleExchange()` 63 行 → `handleExchange()` (~25 行) + `validateExchangeToken(string $token): ?array` (~20 行) + `createSession(array $data): void` (~15 行)

    **AuthCallback:**
    - `processCallback()` 58 行 → `processCallback()` (~25 行) + `exchangeCodeForTokens(string $code): array` (~20 行)
  </action>
  <verify>
    <automated>for f in includes/webhook/class-event-dispatcher.php includes/webhook/class-webhook-receiver.php includes/auth/class-session-transfer.php includes/auth/class-auth-callback.php; do php -l "$f"; done</automated>
    <manual>所有方法 ≤ 50 行</manual>
  </verify>
  <done>Webhook 和 Auth 方法全部 ≤ 50 行</done>
</task>

<task type="auto">
  <name>Task 4: 重構其他長方法</name>
  <files>
    includes/services/class-content-service.php
    includes/admin/tabs/class-developer-tab.php
    includes/integration/class-fluent-cart-connector.php
    includes/cli/class-migrate-avatars-command.php
  </files>
  <action>
    **ContentService:**
    - `downloadAndUpload()` 85 行 → `downloadAndUpload()` (~25 行) + `downloadImage(string $url): string` (~20 行) + `uploadToMediaLibrary(string $tmp_file, string $filename, int $user_id): int` (~25 行)

    **DeveloperTab:**
    - `get_api_endpoints()` 82 行 → 這是結構化資料定義，拆成 `get_message_endpoints()` + `get_user_endpoints()` + `get_utility_endpoints()` 各 ~25 行
    - `get_hooks_data()` 54 行 → `get_hooks_data()` (~25 行) + `get_action_hooks(): array` (~15 行) + `get_filter_hooks(): array` (~10 行)

    **FluentCartConnector:**
    - `renderBindingSection()` 63 行 → `renderBindingSection()` (~25 行) + `getBindingSectionData(\WP_User $user): array` (~25 行)

    **MigrateAvatarsCommand:**
    - `run()` 64 行 → `run()` (~25 行) + `migrateUserAvatar(int $user_id, string $picture_url): bool` (~25 行)
  </action>
  <verify>
    <automated>for f in includes/services/class-content-service.php includes/admin/tabs/class-developer-tab.php includes/integration/class-fluent-cart-connector.php includes/cli/class-migrate-avatars-command.php; do php -l "$f"; done</automated>
    <manual>所有方法 ≤ 50 行</manual>
  </verify>
  <done>ContentService、DeveloperTab、FluentCartConnector、MigrateAvatarsCommand 方法全部 ≤ 50 行</done>
</task>

<task type="auto">
  <name>Task 5: 重構 Plan 01/02 遺留的長方法</name>
  <files>
    includes/liff/class-liff-user-processor.php
    includes/services/class-user-service.php
    includes/class-plugin.php
  </files>
  <action>
    Plan 14-01 拆分後，這些檔案中可能仍有 > 50 行的方法：

    **LiffUserProcessor（從 LiffHandler 搬來）：**
    - `processVerification()` 如果仍 > 50 行 → 拆成 `processVerification()` + `resolveOrCreateUser(array $profile, string $access_token): int`
    - `createNewUser()` 71 行 → 拆成 `createNewUser()` (~30 行) + `buildNewUserData(...)` (~20 行) + `assignUserAvatar(int $user_id, string $picture_url): void` (~15 行)

    **UserService：**
    - `linkUser()` 86 行 → 拆成 `linkUser()` (~35 行) + `insertBinding(int $user_id, string $line_uid, array $profile): bool` (~25 行) + `updateExistingBinding(int $user_id, array $profile): bool` (~20 行)

    **Plugin：**
    - `override_avatar_with_line()` 60 行 → 拆成 `override_avatar_with_line()` (~25 行) + `resolveLineAvatar($id_or_email): ?string` (~25 行)

    **注意：** 這些方法在 Plan 01 執行後可能已自然縮短。先掃描確認實際行數再決定是否需要重構。
  </action>
  <verify>
    <automated>for f in includes/liff/class-liff-user-processor.php includes/services/class-user-service.php includes/class-plugin.php; do php -l "$f"; done</automated>
    <manual>所有方法 ≤ 50 行</manual>
  </verify>
  <done>Plan 01/02 遺留的長方法全部重構完成</done>
</task>

<task type="auto">
  <name>Task 6: 最終驗證 — 零 50+ 行方法 + 零 300+ 行檔案</name>
  <files>
    includes/
  </files>
  <action>
    1. 長方法掃描：
    ```python
    # 掃描所有 includes/ 下的 PHP 方法，確認零 > 50 行
    ```
    結果應為空。

    2. 檔案行數掃描：
    ```bash
    for f in $(find includes/ -name "*.php"); do
      lines=$(wc -l < "$f")
      if [ "$lines" -gt 300 ]; then echo "OVER: $lines $f"; fi
    done
    ```
    結果應為空。

    3. PHP 語法全量檢查：
    ```bash
    find includes/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
    ```
    結果應為空（無語法錯誤）。

    4. 如有遺漏，在此 task 中修復。
  </action>
  <verify>
    <automated>echo "=== Files > 300 ===" && for f in $(find includes/ -name "*.php"); do lines=$(wc -l < "$f"); [ "$lines" -gt 300 ] && echo "FAIL: $lines $f"; done && echo "=== Methods > 50 ===" && python3 長方法掃描腳本</automated>
    <manual>兩個掃描都為空 = Phase 14 完成</manual>
  </verify>
  <done>Phase 14 完成：零 300+ 行檔案、零 50+ 行方法</done>
</task>

</tasks>

<verification>
1. 長方法掃描 — 零 > 50 行方法
2. 檔案行數掃描 — 零 > 300 行檔案（≤ 310 行邊界案例可接受）
3. PHP 語法全量檢查 — 零語法錯誤
4. 功能驗證 — 後台設定頁正常、LINE 登入正常（手動測試）
</verification>

<success_criteria>
1. 所有 PHP 方法 ≤ 50 行
2. 所有 PHP 檔案 ≤ 300 行
3. 零語法錯誤
4. 原有功能行為不變
</success_criteria>

<output>
After completion, create `.planning/phases/14-檔案瘦身與方法重構/14-03-SUMMARY.md`
</output>
