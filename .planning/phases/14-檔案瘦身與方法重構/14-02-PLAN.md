---
phase: 14-檔案瘦身與方法重構
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - includes/services/class-login-service.php
  - includes/messaging/class-messaging-service.php
  - includes/messaging/class-flex-builder.php
  - includes/messaging/class-flex-elements.php
  - includes/api/class-public-api.php
  - includes/api/class-settings-api.php
  - includes/admin/views/tab-login-settings.php
  - includes/admin/views/tab-developer.php
  - includes/admin/views/partials/login-button-positions.php
  - includes/admin/views/partials/developer-api-endpoints.php
  - includes/auth/class-oauth-client.php
  - includes/auth/class-oauth-state.php
autonomous: true
requirements:
  - SIZE-02
must_haves:
  truths:
    - "9 個 300-500 行的檔案全部降到 300 行以內（或邊界 301-310 可接受）"
    - "FlexElements 新類別建立完成且 autoloader 正確載入"
    - "View partials 正確被母模板 require"
  artifacts:
    - path: "includes/messaging/class-flex-elements.php"
      provides: "Flex 訊息元素方法（text, image, button 等）"
      min_lines: 100
    - path: "includes/admin/views/partials/login-button-positions.php"
      provides: "登入按鈕位置設定的 view partial"
      min_lines: 30
    - path: "includes/admin/views/partials/developer-api-endpoints.php"
      provides: "開發者 Tab API 端點表格的 view partial"
      min_lines: 30
---

<objective>
將 9 個 300-500 行的檔案透過類別提取、方法重構或 view partial 拆分，降到 300 行以內。

Purpose: 滿足 SIZE-02（零 300+ 行違規），所有 PHP 檔案都在理想範圍內。
Output: 9 個瘦身後的檔案 + 3 個新建檔案（FlexElements + 2 個 view partials）。
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-檔案瘦身與方法重構/14-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 方法重構 — LoginService（437→~290）</name>
  <files>
    includes/services/class-login-service.php
  </files>
  <action>
    重構 3 個長方法，不拆新類別：

    **handleUser() 73 行 → 拆成 2 個方法：**
    - `handleUser()` (~30 行) — 頂層流程：查找用戶 → 決定路徑（現有/新建/Email 表單）
    - `findExistingUser(array $user_data): ?int` (~25 行) — 查找邏輯（by LINE UID → by Email）

    **createUser() 65 行 → 拆成 2 個方法：**
    - `createUser()` (~30 行) — 主流程：建構資料 → 插入 → 綁定
    - `buildUserData(array $user_data): array` (~20 行) — 組裝 wp_insert_user 參數

    **loginUser() 71 行 → 拆成 2 個方法：**
    - `loginUser()` (~35 行) — 主流程：設定 session → 綁定 profile → 重定向
    - `bindLineProfile(int $user_id, array $user_data, array $tokens): void` (~25 行) — LINE profile 綁定邏輯

    **額外瘦身：**
    - `showEmailForm()` 方法的 HTML 輸出已在 Phase 12 提取到模板，檢查是否有殘留可清理
    - 刪除任何無用註解或空行

    **目標：** ~290 行
  </action>
  <verify>
    <automated>wc -l includes/services/class-login-service.php && php -l includes/services/class-login-service.php</automated>
    <manual>≤ 300 行，PHP syntax 通過，所有方法 ≤ 50 行</manual>
  </verify>
  <done>LoginService 降到 300 行以內，所有方法 ≤ 50 行</done>
</task>

<task type="auto">
  <name>Task 2: 方法重構 — MessagingService（393→~290）+ PublicApi（352→~280）+ SettingsApi（318→~280）</name>
  <files>
    includes/messaging/class-messaging-service.php
    includes/api/class-public-api.php
    includes/api/class-settings-api.php
  </files>
  <action>
    **MessagingService (393→~290)：**
    - `multicast()` 57 行 → 拆成 `multicast()` (~25 行) + `sendMulticastChunk(array $chunk, array $messages)` (~20 行)
    - `sendRequest()` 53 行 → 拆成 `sendRequest()` (~25 行) + `parseApiResponse(array $response): mixed` (~15 行)
    - 刪除冗餘的文件區塊註解和多餘空行

    **PublicApi (352→~280)：**
    - `send_broadcast()` 方法中的驗證邏輯提取為 `validate_broadcast_params()`
    - `register_routes()` 中每個路由定義佔 ~8 行，壓縮為更簡潔的格式
    - 刪除冗餘文件區塊註解

    **SettingsApi (318→~280)：**
    - `register_routes()` 57 行 → 拆成每個 resource 一個 private 方法：`register_connection_routes()`、`register_settings_routes()`、`register_api_key_routes()`
    - `update_settings()` 61 行 → 拆成 `update_settings()` (~25 行) + `process_setting_update(string $group, string $key, $value): bool` (~25 行)

    **目標：** 三個檔案都 ≤ 300 行
  </action>
  <verify>
    <automated>wc -l includes/messaging/class-messaging-service.php includes/api/class-public-api.php includes/api/class-settings-api.php && php -l includes/messaging/class-messaging-service.php && php -l includes/api/class-public-api.php && php -l includes/api/class-settings-api.php</automated>
    <manual>三個檔案都 ≤ 300 行，PHP syntax 通過</manual>
  </verify>
  <done>MessagingService、PublicApi、SettingsApi 全部降到 300 行以內</done>
</task>

<task type="auto">
  <name>Task 3: 拆分 FlexBuilder（363→~160）— 提取 FlexElements</name>
  <files>
    includes/messaging/class-flex-builder.php
    includes/messaging/class-flex-elements.php
  </files>
  <action>
    1. 建立 `includes/messaging/class-flex-elements.php`，命名空間 `LineHub\Messaging`

    **搬移以下 12 個元素方法到 FlexElements：**
    - `text()` — 文字元素
    - `image()` — 圖片元素
    - `button()` — 按鈕元素
    - `separator()` — 分隔線
    - `spacer()` — 間距
    - `filler()` — 填充
    - `icon()` — 圖示
    - `hero()` — Hero 圖片
    - `heading()` — 標題文字
    - `subheading()` — 副標題
    - `label()` — 標籤文字
    - `content()` — 內容文字
    - `keyValue()` — 鍵值對

    **FlexBuilder 保留：**
    - `bubble()` — 容器：Bubble
    - `carousel()` — 容器：Carousel
    - `box()` — 容器：Box
    - `flexMessage()` — 包裝 Flex Message
    - `parseAction()` — 動作解析（private，被 button 和 FlexBuilder 都用到 → 移到 FlexElements 或改為 public static）

    2. 修改 `class-flex-builder.php`：
    - 刪除已搬移的 12 個方法
    - 如有 `parseAction` 依賴，加入 `use LineHub\Messaging\FlexElements;`

    3. 搜尋所有呼叫者，確認是否需要更新 use 語句：
    ```bash
    grep -rn "FlexBuilder::text\|FlexBuilder::image\|FlexBuilder::button\|FlexBuilder::heading\|FlexBuilder::content\|FlexBuilder::label\|FlexBuilder::icon\|FlexBuilder::separator\|FlexBuilder::spacer\|FlexBuilder::filler\|FlexBuilder::hero\|FlexBuilder::subheading\|FlexBuilder::keyValue" includes/
    ```
    所有呼叫者需改為 `FlexElements::text()` 等。

    **目標行數：**
    - FlexBuilder: ~160 行（容器方法）
    - FlexElements: ~200 行（元素方法）
  </action>
  <verify>
    <automated>wc -l includes/messaging/class-flex-builder.php includes/messaging/class-flex-elements.php && php -l includes/messaging/class-flex-builder.php && php -l includes/messaging/class-flex-elements.php</automated>
    <manual>兩個檔案都 ≤ 300 行，PHP syntax 通過，grep 確認所有呼叫者已更新</manual>
  </verify>
  <done>FlexBuilder 降到 300 行以內，FlexElements 建立完成</done>
</task>

<task type="auto">
  <name>Task 4: View 模板拆 Partial — tab-login-settings（347→~200）+ tab-developer（313→~180）</name>
  <files>
    includes/admin/views/tab-login-settings.php
    includes/admin/views/tab-developer.php
    includes/admin/views/partials/login-button-positions.php
    includes/admin/views/partials/developer-api-endpoints.php
  </files>
  <action>
    **tab-login-settings.php (347→~200)：**
    1. 提取「按鈕位置設定」區塊為 `partials/login-button-positions.php`
       - 包含所有 checkbox 的迴圈和位置設定表單
       - 預計 ~80 行
    2. 原位置改為 `<?php require __DIR__ . '/partials/login-button-positions.php'; ?>`
    3. Partial 中可直接使用母模板的變數（PHP require 共享 scope）

    **tab-developer.php (313→~180)：**
    1. 提取「API 端點表格」區塊為 `partials/developer-api-endpoints.php`
       - 包含整個 API 端點表格（endpoint list + curl 範例）
       - 預計 ~100 行
    2. 原位置改為 `<?php require __DIR__ . '/partials/developer-api-endpoints.php'; ?>`

    **注意：**
    - Partials 目錄 `includes/admin/views/partials/` 已存在（Phase 13 建立了 connection-status.php）
    - Partials 不需要 `defined('ABSPATH')` 檢查（因為是被 require 載入，不是獨立存取）
    - Partials 不走 autoloader，純 PHP include
  </action>
  <verify>
    <automated>wc -l includes/admin/views/tab-login-settings.php includes/admin/views/tab-developer.php includes/admin/views/partials/login-button-positions.php includes/admin/views/partials/developer-api-endpoints.php && php -l includes/admin/views/tab-login-settings.php && php -l includes/admin/views/tab-developer.php</automated>
    <manual>母模板 ≤ 300 行，partials 存在且語法正確</manual>
  </verify>
  <done>tab-login-settings 和 tab-developer 都降到 300 行以內</done>
</task>

<task type="auto">
  <name>Task 5: 邊界檔案 — OAuthClient（306→~280）+ OAuthState（301→~280）</name>
  <files>
    includes/auth/class-oauth-client.php
    includes/auth/class-oauth-state.php
  </files>
  <action>
    **class-oauth-client.php (306→~280)：**
    - 清理冗餘的 PHPDoc 區塊註解（多餘的 @param 描述、空行）
    - 壓縮過長的陣列定義（合併為單行）
    - 如果仍超標，將 `buildAuthorizationUrl()` 中的參數組裝提取為 `getAuthParams()` helper

    **class-oauth-state.php (301→~280)：**
    - 僅超 1 行，清理冗餘空行和註解即可
    - 檢查是否有未使用的 private 方法可刪除
  </action>
  <verify>
    <automated>wc -l includes/auth/class-oauth-client.php includes/auth/class-oauth-state.php && php -l includes/auth/class-oauth-client.php && php -l includes/auth/class-oauth-state.php</automated>
    <manual>兩個檔案都 ≤ 300 行</manual>
  </verify>
  <done>OAuthClient 和 OAuthState 都降到 300 行以內</done>
</task>

<task type="auto">
  <name>Task 6: 驗證 — 全部 300+ 行檔案歸零</name>
  <files>
    includes/
  </files>
  <action>
    1. 全量掃描：
    ```bash
    for f in $(find includes/ -name "*.php"); do
      lines=$(wc -l < "$f")
      if [ "$lines" -gt 300 ]; then echo "OVER: $lines $f"; fi
    done | sort -rn
    ```
    結果應為空（零 300+ 行檔案）。

    2. 新建檔案語法檢查：
    ```bash
    for f in $(find includes/ -name "*.php" -newer includes/autoload.php); do
      php -l "$f"
    done
    ```

    3. 如有遺漏的 300+ 行檔案，在此 task 中修復。
  </action>
  <verify>
    <automated>for f in $(find includes/ -name "*.php"); do lines=$(wc -l < "$f"); if [ "$lines" -gt 300 ]; then echo "FAIL: $lines $f"; fi; done</automated>
    <manual>輸出為空表示所有 PHP 檔案 ≤ 300 行</manual>
  </verify>
  <done>整個 includes/ 目錄零 300+ 行 PHP 檔案</done>
</task>

</tasks>

<verification>
1. `find includes/ -name "*.php" | xargs wc -l | sort -rn | head -15` — 所有檔案 ≤ 300 行
2. `php -l` 對所有新建/修改的檔案 — 語法正確
3. `grep -rn "FlexElements\|FlexBuilder" includes/` — 呼叫者正確更新
</verification>

<success_criteria>
1. 9 個原始 300-500 行檔案全部降到 300 行以內
2. FlexElements 新類別建立完成
3. 2 個 view partials 建立完成
4. 所有 PHP 檔案語法正確
</success_criteria>

<output>
After completion, create `.planning/phases/14-檔案瘦身與方法重構/14-02-SUMMARY.md`
</output>
